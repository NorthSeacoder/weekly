---
import Layout from '~/layouts/PageLayout.astro';
import { verifyAdminAccess } from '~/utils/auth';

// é™æ€æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨å®¢æˆ·ç«¯å¤„ç†URLå‚æ•°
const adminKey = import.meta.env.ADMIN_ACCESS_KEY || 'admin_2025_weekly';

// å¦‚æœå·²ç»æœ‰æƒé™ï¼ˆé€šè¿‡Cookieï¼‰ï¼Œç›´æ¥è·³è½¬
if (verifyAdminAccess(Astro.request)) {
    return Astro.redirect('/admin/review');
}

const metadata = {
    title: 'ç®¡ç†å‘˜ç™»å½•',
    description: 'ç®¡ç†å‘˜è®¿é—®éªŒè¯',
    robots: {
        index: false,
        follow: false
    }
};
---

<Layout metadata={metadata}>
    <div class="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <div class="mx-auto h-20 w-20 flex items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900">
                    <span class="text-3xl">ğŸ”</span>
                </div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900 dark:text-white">
                    ç®¡ç†å‘˜è®¿é—®éªŒè¯
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">
                    è¯·è¾“å…¥è®¿é—®å¯†é’¥ä»¥ç»§ç»­
                </p>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8">
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="access-key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            è®¿é—®å¯†é’¥
                        </label>
                        <div class="mt-1">
                            <input 
                                id="access-key" 
                                name="access-key" 
                                type="password" 
                                required 
                                class="appearance-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                                placeholder="è¯·è¾“å…¥è®¿é—®å¯†é’¥"
                            />
                        </div>
                    </div>

                    <div>
                        <button 
                            type="submit" 
                            class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            id="login-button"
                        >
                            <span id="login-text">éªŒè¯è®¿é—®</span>
                            <div id="login-loading" class="hidden">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            </div>
                        </button>
                    </div>

                    <div id="error-message" class="hidden text-red-600 dark:text-red-400 text-sm text-center bg-red-50 dark:bg-red-900/20 p-3 rounded-lg">
                        <!-- é”™è¯¯ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </form>

                <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        <p class="mb-2">ğŸ’¡ <strong>æç¤ºï¼š</strong></p>
                        <ul class="space-y-1 list-disc list-inside">
                            <li>è®¿é—®å¯†é’¥åœ¨ç¯å¢ƒå˜é‡ ADMIN_ACCESS_KEY ä¸­é…ç½®</li>
                            <li>ä¹Ÿå¯ä»¥é€šè¿‡URLå‚æ•° ?key=å¯†é’¥ ç›´æ¥è®¿é—®</li>
                            <li>ç™»å½•åå°†ä¿æŒ24å°æ—¶æœ‰æ•ˆæœŸ</li>
                        </ul>
                        

                    </div>
                </div>
            </div>

            <div class="text-center">
                <a href="/" class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium transition-colors">
                    â† è¿”å›é¦–é¡µ
                </a>
            </div>
        </div>
    </div>

    <script define:vars={{ adminKey }}>
        // è·å–URLå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const urlKey = urlParams.get('key');
        const returnPath = urlParams.get('return') || '/admin/review';
        const expectedKey = adminKey; // ä»æœåŠ¡ç«¯ç¯å¢ƒå˜é‡ä¼ é€’
        

        
        // å¦‚æœURLä¸­æœ‰keyå‚æ•°ï¼Œè‡ªåŠ¨éªŒè¯
        if (urlKey) {
            if (urlKey === expectedKey) {
                // è®¾ç½®Cookieå¹¶è·³è½¬
                // å°è¯•å¤šç§Cookieè®¾ç½®æ–¹å¼
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                let cookieString;
                
                if (isLocalhost) {
                    // æœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œä½¿ç”¨æœ€ç®€å•çš„è®¾ç½®
                    cookieString = `admin_key=${expectedKey}; Max-Age=${60 * 60 * 24}; Path=/`;
                } else {
                    // ç”Ÿäº§ç¯å¢ƒæˆ–å…¶ä»–ç¯å¢ƒ
                    const domain = window.location.hostname;
                    cookieString = `admin_key=${expectedKey}; Max-Age=${60 * 60 * 24}; Path=/; Domain=${domain}`;
                }
                document.cookie = cookieString;
                
                // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿Cookieè®¾ç½®æˆåŠŸ
                setTimeout(() => {
                    window.location.href = returnPath;
                }, 100);
            } else {
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const errorDiv = document.getElementById('error-message');
                if (errorDiv) {
                    errorDiv.textContent = 'è®¿é—®å¯†é’¥ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•';
                    errorDiv.classList.remove('hidden');
                }
            }
        }
        
        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const button = document.getElementById('login-button');
            const text = document.getElementById('login-text');
            const loading = document.getElementById('login-loading');
            const keyInput = document.getElementById('access-key');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (button) button.disabled = true;
            if (text) text.style.display = 'none';
            if (loading) loading.classList.remove('hidden');
            hideError();
            
            const key = keyInput ? keyInput.value.trim() : '';
            
            if (!key) {
                showError('è¯·è¾“å…¥è®¿é—®å¯†é’¥');
                resetButton();
                return;
            }
            
            if (key === expectedKey) {
                // éªŒè¯æˆåŠŸï¼Œè®¾ç½®Cookieå¹¶è·³è½¬
                // å°è¯•å¤šç§Cookieè®¾ç½®æ–¹å¼
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                let cookieString;
                
                if (isLocalhost) {
                    // æœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œä½¿ç”¨æœ€ç®€å•çš„è®¾ç½®
                    cookieString = `admin_key=${key}; Max-Age=${60 * 60 * 24}; Path=/`;
                } else {
                    // ç”Ÿäº§ç¯å¢ƒæˆ–å…¶ä»–ç¯å¢ƒ
                    const domain = window.location.hostname;
                    cookieString = `admin_key=${key}; Max-Age=${60 * 60 * 24}; Path=/; Domain=${domain}`;
                }
                document.cookie = cookieString;
                
                // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿Cookieè®¾ç½®æˆåŠŸ
                setTimeout(() => {
                    window.location.href = returnPath;
                }, 100);
            } else {
                showError('è®¿é—®å¯†é’¥ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•');
                resetButton();
            }
            
            function showError(message) {
                const errorDiv = document.getElementById('error-message');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.classList.remove('hidden');
                }
            }
            
            function hideError() {
                const errorDiv = document.getElementById('error-message');
                if (errorDiv) {
                    errorDiv.classList.add('hidden');
                }
            }
            
            function resetButton() {
                if (button) button.disabled = false;
                if (text) text.style.display = 'inline';
                if (loading) loading.classList.add('hidden');
            }
        });
    </script>
</Layout> 