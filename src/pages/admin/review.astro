---
import Layout from '~/layouts/PageLayout.astro';
import {ContentService, type ContentWithRelations} from '../../../lib/database-service';

// é™æ€æ¨¡å¼ä¸‹ï¼Œæƒé™éªŒè¯ç§»åˆ°å®¢æˆ·ç«¯
// è·å–å¾…å®¡æ ¸å†…å®¹å’Œç»Ÿè®¡ä¿¡æ¯
const pendingContent: ContentWithRelations[] = await ContentService.getPendingReview(50);
const statusStats = await ContentService.getStatusStats();

// ä»ç¯å¢ƒå˜é‡è¯»å–ç®¡ç†å‘˜å¯†é’¥
const expectedAdminKey = import.meta.env.ADMIN_ACCESS_KEY || 'admin_2025_weekly';

const metadata = {
    title: 'å†…å®¹å®¡æ ¸ç®¡ç†',
    description: 'ç®¡ç†å’Œå®¡æ ¸å‘¨åˆŠå†…å®¹',
    robots: {
        index: false,
        follow: false
    }
};
---

<Layout metadata={metadata}>
    <!-- å®¢æˆ·ç«¯æƒé™éªŒè¯ -->
    <script define:vars={{expectedAdminKey}}>
        // æ£€æŸ¥ç®¡ç†å‘˜Cookie
        function getCookie(name) {
            // æ–¹æ³•1: åŸå§‹æ–¹æ³•
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                const result = parts.pop();
                const finalValue = result ? result.split(';').shift() || null : null;
                if (finalValue) return finalValue;
            }
            
            // æ–¹æ³•2: æ›´å¥å£®çš„è§£æ
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const trimmed = cookie.trim();
                if (trimmed.startsWith(`${name}=`)) {
                    const cookieValue = trimmed.substring(name.length + 1);
                    return cookieValue;
                }
            }
            
            return null;
        }

        const adminKey = getCookie('admin_key');
        const expectedKey = expectedAdminKey;

        // è®¾ç½®ä¸ºå…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
        window.expectedAdminKey = expectedAdminKey;

        if (!adminKey || adminKey !== expectedKey) {
            // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰å¯†é’¥
            const urlParams = new URLSearchParams(window.location.search);
            const urlKey = urlParams.get('key');
            
            if (urlKey === window.expectedAdminKey) {
                // å°è¯•è®¾ç½®Cookie
                const cookieString = `admin_key=${window.expectedAdminKey}; Max-Age=${60 * 60 * 24}; Path=/`;
                document.cookie = cookieString;
                // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨Cookie
                window.location.href = '/admin/review';
                return;
            }
            
            // æ²¡æœ‰æƒé™ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
            window.location.href = '/admin/login?return=' + encodeURIComponent('/admin/review');
        }
    </script>

    <div class='min-h-screen bg-gray-50 dark:bg-gray-900 py-8'>
        <div class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8'>
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class='mb-8'>
                <div class='flex items-center justify-between'>
                    <div>
                        <h1 class='text-3xl font-bold text-gray-900 dark:text-white'>å†…å®¹å®¡æ ¸ç®¡ç†</h1>
                        <p class='mt-2 text-gray-600 dark:text-gray-400'>ç®¡ç†å’Œå®¡æ ¸å‘¨åˆŠå†…å®¹çš„å‘å¸ƒçŠ¶æ€</p>
                    </div>
                    <div class='flex space-x-4'>
                        <a
                            href='/admin'
                            class='px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors'>
                            è¿”å›ç®¡ç†
                        </a>
                        <a
                            href='/'
                            class='px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors'>
                            æŸ¥çœ‹ç½‘ç«™
                        </a>
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class='grid grid-cols-1 md:grid-cols-4 gap-6 mb-8'>
                {
                    statusStats.map((stat) => {
                        const statusConfig = {
                            draft: {label: 'è‰ç¨¿', color: 'yellow', icon: 'ğŸ“'},
                            published: {label: 'å·²å‘å¸ƒ', color: 'green', icon: 'âœ…'},
                            hidden: {label: 'å·²éšè—', color: 'gray', icon: 'ğŸ‘ï¸'},
                            archived: {label: 'å·²å½’æ¡£', color: 'blue', icon: 'ğŸ“¦'}
                        };
                        const config = statusConfig[stat.status as keyof typeof statusConfig] || {
                            label: stat.status,
                            color: 'gray',
                            icon: 'ğŸ“„'
                        };

                        return (
                            <div
                                class={`bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border-l-4 border-${config.color}-500`}>
                                <div class='flex items-center'>
                                    <div class='text-2xl mr-3'>{config.icon}</div>
                                    <div>
                                        <p class='text-sm font-medium text-gray-600 dark:text-gray-400'>
                                            {config.label}
                                        </p>
                                        <p class='text-2xl font-bold text-gray-900 dark:text-white'>{stat.count}</p>
                                    </div>
                                </div>
                            </div>
                        );
                    })
                }
            </div>

            <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
            <div
                class='bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-6'
                id='batch-toolbar'
                style='display: none;'>
                <div class='flex items-center justify-between'>
                    <div class='flex items-center space-x-4'>
                        <span class='text-sm text-gray-600 dark:text-gray-400' id='selected-count'>å·²é€‰æ‹© 0 é¡¹</span>
                        <button id='select-all' class='text-blue-600 hover:text-blue-700 text-sm font-medium'
                            >å…¨é€‰</button
                        >
                        <button id='clear-selection' class='text-gray-600 hover:text-gray-700 text-sm font-medium'
                            >æ¸…é™¤é€‰æ‹©</button
                        >
                    </div>
                    <div class='flex space-x-2'>
                        <button
                            data-action='batch-update'
                            data-status='published'
                            class='px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm'>
                            æ‰¹é‡å‘å¸ƒ
                        </button>
                        <button
                            data-action='batch-update'
                            data-status='hidden'
                            class='px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm'>
                            æ‰¹é‡éšè—
                        </button>
                        <button
                            data-action='batch-update'
                            data-status='archived'
                            class='px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm'>
                            æ‰¹é‡å½’æ¡£
                        </button>
                    </div>
                </div>
            </div>

            <!-- å†…å®¹è¡¨æ ¼ -->
            <div class='bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden'>
                <div class='px-6 py-4 border-b border-gray-200 dark:border-gray-700'>
                    <h2 class='text-lg font-semibold text-gray-900 dark:text-white'>
                        å¾…å®¡æ ¸å†…å®¹ ({pendingContent.length})
                    </h2>
                </div>

                {
                    pendingContent.length === 0 ? (
                        <div class='text-center py-12'>
                            <div class='text-6xl mb-4'>ğŸ‰</div>
                            <p class='text-xl text-gray-600 dark:text-gray-400'>æ²¡æœ‰å¾…å®¡æ ¸çš„å†…å®¹</p>
                            <p class='text-gray-500 dark:text-gray-500'>æ‰€æœ‰å†…å®¹éƒ½å·²å¤„ç†å®Œæ¯•</p>
                        </div>
                    ) : (
                        <div class='overflow-x-auto'>
                            <table class='min-w-full divide-y divide-gray-200 dark:divide-gray-700'>
                                <thead class='bg-gray-50 dark:bg-gray-700'>
                                    <tr>
                                        <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-8'>
                                            <input
                                                type='checkbox'
                                                id='select-all-header'
                                                class='w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500'
                                            />
                                        </th>
                                        <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                            æ ‡é¢˜
                                        </th>
                                        <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                            åˆ†ç±»
                                        </th>
                                        <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                            çŠ¶æ€
                                        </th>
                                        <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                            åˆ›å»ºæ—¶é—´
                                        </th>
                                        <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                            å­—æ•°
                                        </th>
                                        <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                            æ“ä½œ
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class='bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700'>
                                    {pendingContent.map((content) => {
                                        const statusConfig = {
                                            draft: {
                                                label: 'è‰ç¨¿',
                                                bgColor:
                                                    'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'
                                            },
                                            hidden: {
                                                label: 'å·²éšè—',
                                                bgColor: 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200'
                                            },
                                            archived: {
                                                label: 'å·²å½’æ¡£',
                                                bgColor: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
                                            }
                                        };
                                        const config = statusConfig[content.status as keyof typeof statusConfig] || {
                                            label: content.status,
                                            bgColor: 'bg-gray-100 text-gray-800'
                                        };

                                        return (
                                            <tr class='hover:bg-gray-50 dark:hover:bg-gray-700'>
                                                <td class='px-6 py-4 whitespace-nowrap'>
                                                    <input
                                                        type='checkbox'
                                                        class='content-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500'
                                                        data-content-id={content.id}
                                                    />
                                                </td>
                                                <td class='px-6 py-4'>
                                                    <div class='text-sm font-medium text-gray-900 dark:text-white line-clamp-2'>
                                                        {content.title}
                                                    </div>
                                                    {content.description && (
                                                        <div class='text-sm text-gray-500 dark:text-gray-400 line-clamp-1 mt-1'>
                                                            {content.description}
                                                        </div>
                                                    )}
                                                    <div class='text-xs text-gray-400 mt-1'>ID: {content.id}</div>
                                                </td>
                                                <td class='px-6 py-4 whitespace-nowrap'>
                                                    {content.category_name && (
                                                        <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'>
                                                            {content.category_name}
                                                        </span>
                                                    )}
                                                </td>
                                                <td class='px-6 py-4 whitespace-nowrap'>
                                                    <span
                                                        class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${config.bgColor}`}>
                                                        {config.label}
                                                    </span>
                                                </td>
                                                <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400'>
                                                    {new Date(content.created_at).toLocaleDateString('zh-CN')}
                                                </td>
                                                <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400'>
                                                    {content.word_count}
                                                </td>
                                                <td class='px-6 py-4 whitespace-nowrap text-sm font-medium'>
                                                    <div class='flex space-x-2'>
                                                        <button
                                                            data-action='preview'
                                                            data-content-id={content.id}
                                                            class='text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300'
                                                            title='é¢„è§ˆ'>
                                                            ğŸ‘ï¸
                                                        </button>
                                                        <button
                                                            data-action='update-status'
                                                            data-content-id={content.id}
                                                            data-status='published'
                                                            class='text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300'
                                                            title='å‘å¸ƒ'>
                                                            âœ…
                                                        </button>
                                                        <button
                                                            data-action='update-status'
                                                            data-content-id={content.id}
                                                            data-status='hidden'
                                                            class='text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300'
                                                            title='éšè—'>
                                                            ğŸ‘ï¸â€ğŸ—¨ï¸
                                                        </button>
                                                        <button
                                                            data-action='update-status'
                                                            data-content-id={content.id}
                                                            data-status='archived'
                                                            class='text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300'
                                                            title='å½’æ¡£'>
                                                            ğŸ“¦
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )
                }
            </div>
        </div>
    </div>

    <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id='preview-modal' class='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50'>
        <div class='bg-white dark:bg-gray-800 rounded-lg max-w-4xl max-h-[90vh] w-full mx-4 flex flex-col'>
            <div class='px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between'>
                <h3 id='preview-title' class='text-lg font-semibold text-gray-900 dark:text-white'></h3>
                <button data-action='close-preview' class='text-gray-400 hover:text-gray-600 dark:hover:text-gray-300'>
                    <svg class='w-6 h-6' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'
                        ></path>
                    </svg>
                </button>
            </div>
            <div class='flex-1 overflow-y-auto'>
                <div
                    id='preview-content'
                    class='px-6 py-4 prose prose-lg max-w-none dark:prose-invert prose-headings:text-gray-900 dark:prose-headings:text-white prose-p:text-gray-700 dark:prose-p:text-gray-300'>
                    <!-- é¢„è§ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id='loading-overlay' class='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50'>
        <div class='bg-white dark:bg-gray-800 rounded-lg p-6 flex items-center space-x-3'>
            <div class='animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600'></div>
            <span class='text-gray-900 dark:text-white font-medium'>å¤„ç†ä¸­...</span>
        </div>
    </div>

    <script is:inline>
        // é€šç”¨çš„ Cookie è·å–å‡½æ•°
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                const result = parts.pop();
                return result ? result.split(';').shift() || null : null;
            }
            return null;
        }

        // æ›´æ–°æ‰¹é‡æ“ä½œå·¥å…·æ 
        function updateBatchToolbar() {
            const checkboxes = document.querySelectorAll('.content-checkbox:checked');
            const toolbar = document.getElementById('batch-toolbar');
            const counter = document.getElementById('selected-count');

            if (toolbar && counter) {
                if (checkboxes.length > 0) {
                    toolbar.style.display = 'block';
                    counter.textContent = `å·²é€‰æ‹© ${checkboxes.length} é¡¹`;
                } else {
                    toolbar.style.display = 'none';
                }
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.remove('hidden');
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.add('hidden');
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        async function showPreview(id) {
            const modal = document.getElementById('preview-modal');
            const titleEl = document.getElementById('preview-title');
            const contentEl = document.getElementById('preview-content');

            if (!modal || !titleEl || !contentEl) {
                return;
            }

            showLoading();

            try {
                // è·å–è®¤è¯ä¿¡æ¯
                const adminKey = getCookie('admin_key');
                const headerKey = adminKey || window.expectedAdminKey || '';

                const response = await fetch(`/api/admin/preview-content?id=${id}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-key': headerKey
                    }
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const content = result.data;
                    titleEl.textContent = content.title;

                    // ç®€å•çš„ Markdown è½¬ HTMLï¼ˆåŸºç¡€å®ç°ï¼‰
                    const htmlContent = content.content
                        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                        .replace(/^\* (.*$)/gim, '<li>$1</li>')
                        .replace(/^- (.*$)/gim, '<li>$1</li>')
                        .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                        .replace(/\*(.*)\*/gim, '<em>$1</em>')
                        .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" target="_blank" rel="noopener">$1</a>')
                        .replace(/`([^`]+)`/gim, '<code>$1</code>')
                        .replace(/\n\n/gim, '</p><p>')
                        .replace(/\n/gim, '<br>');

                    contentEl.innerHTML = '<p>' + htmlContent + '</p>';
                    modal.classList.remove('hidden');
                } else {
                    alert('è·å–å†…å®¹å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('è·å–å†…å®¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                hideLoading();
            }
        }

        // å…³é—­é¢„è§ˆ
        function closePreview() {
            const modal = document.getElementById('preview-modal');
            if (modal) modal.classList.add('hidden');
        }

        // æ›´æ–°å•ä¸ªå†…å®¹çŠ¶æ€
        async function updateContentStatus(id, status) {
            if (!confirm(`ç¡®å®šè¦å°†å†…å®¹çŠ¶æ€æ›´æ”¹ä¸º"${status}"å—ï¼Ÿ`)) {
                return;
            }

            showLoading();

            try {
                // è·å–è®¤è¯ä¿¡æ¯
                const adminKey = getCookie('admin_key');

                // å¦‚æœæ²¡æœ‰è®¤è¯ä¿¡æ¯ï¼Œå¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•
                if (!adminKey && !window.expectedAdminKey) {
                    alert('ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = '/admin/login?return=' + encodeURIComponent('/admin/review');
                    return;
                }

                const response = await fetch('/api/admin/update-status', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-key': adminKey || window.expectedAdminKey || ''
                    },
                    body: JSON.stringify({id, status})
                });

                const result = await response.json();

                if (result.success) {
                    window.location.reload();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                hideLoading();
            }
        }

        // æ‰¹é‡æ›´æ–°çŠ¶æ€
        async function batchUpdateStatus(status) {
            const checkboxes = document.querySelectorAll('.content-checkbox:checked');
            const ids = Array.from(checkboxes)
                .map((cb) => parseInt(cb.getAttribute('data-content-id') || '0'))
                .filter((id) => id > 0);

            if (ids.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„å†…å®¹');
                return;
            }

            if (!confirm(`ç¡®å®šè¦å°† ${ids.length} é¡¹å†…å®¹çŠ¶æ€æ›´æ”¹ä¸º"${status}"å—ï¼Ÿ`)) {
                return;
            }

            showLoading();

            try {
                // è·å–è®¤è¯ä¿¡æ¯
                const adminKey = getCookie('admin_key');

                // å¦‚æœæ²¡æœ‰è®¤è¯ä¿¡æ¯ï¼Œå¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•
                if (!adminKey && !window.expectedAdminKey) {
                    alert('ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = '/admin/login?return=' + encodeURIComponent('/admin/review');
                    return;
                }

                const response = await fetch('/api/admin/batch-update-status', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-key': adminKey || window.expectedAdminKey || ''
                    },
                    body: JSON.stringify({ids, status})
                });

                const result = await response.json();

                if (result.success) {
                    window.location.reload();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                hideLoading();
            }
        }

        // äº‹ä»¶å§”æ‰˜å¤„ç†æ‰€æœ‰æŒ‰é’®ç‚¹å‡»
        function handleButtonClick(event) {
            const button = event.target.closest('button[data-action]');
            if (!button) return;

            const action = button.getAttribute('data-action');
            const contentId = button.getAttribute('data-content-id');
            const status = button.getAttribute('data-status');

            switch (action) {
                case 'preview':
                    if (contentId) {
                        showPreview(parseInt(contentId));
                    }
                    break;
                case 'update-status':
                    if (contentId && status) {
                        updateContentStatus(parseInt(contentId), status);
                    }
                    break;
                case 'batch-update':
                    if (status) {
                        batchUpdateStatus(status);
                    }
                    break;
                case 'close-preview':
                    closePreview();
                    break;
            }
        }

        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ‰€æœ‰æŒ‰é’®ç‚¹å‡»
            document.addEventListener('click', handleButtonClick);

            // å…¨é€‰/åé€‰ï¼ˆè¡¨å¤´å¤é€‰æ¡†ï¼‰
            const headerCheckbox = document.getElementById('select-all-header');
            if (headerCheckbox) {
                headerCheckbox.addEventListener('change', function () {
                    const checkboxes = document.querySelectorAll('.content-checkbox');
                    checkboxes.forEach((cb) => (cb.checked = this.checked));
                    updateBatchToolbar();
                });
            }

            // å…¨é€‰æŒ‰é’®
            const selectAllBtn = document.getElementById('select-all');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function () {
                    const checkboxes = document.querySelectorAll('.content-checkbox');
                    checkboxes.forEach((cb) => (cb.checked = true));
                    if (headerCheckbox) headerCheckbox.checked = true;
                    updateBatchToolbar();
                });
            }

            // æ¸…é™¤é€‰æ‹©æŒ‰é’®
            const clearSelectionBtn = document.getElementById('clear-selection');
            if (clearSelectionBtn) {
                clearSelectionBtn.addEventListener('click', function () {
                    const checkboxes = document.querySelectorAll('.content-checkbox');
                    checkboxes.forEach((cb) => (cb.checked = false));
                    if (headerCheckbox) headerCheckbox.checked = false;
                    updateBatchToolbar();
                });
            }

            // ä¸ºæ‰€æœ‰å†…å®¹å¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.content-checkbox').forEach((checkbox) => {
                checkbox.addEventListener('change', updateBatchToolbar);
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            const previewModal = document.getElementById('preview-modal');
            if (previewModal) {
                previewModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        closePreview();
                    }
                });
            }

            // ESCé”®å…³é—­é¢„è§ˆ
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closePreview();
                }
            });


        });
    </script>
</Layout>

