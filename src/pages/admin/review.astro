---
import Layout from '~/layouts/PageLayout.astro';
import {ContentService, type ContentWithRelations} from '../../../lib/database-service';

// é™æ€æ¨¡å¼ä¸‹ï¼Œæƒé™éªŒè¯ç§»åˆ°å®¢æˆ·ç«¯
// è·å–å¾…å®¡æ ¸å†…å®¹å’Œç»Ÿè®¡ä¿¡æ¯
const pendingContent: ContentWithRelations[] = await ContentService.getPendingReview(50);
const statusStats = await ContentService.getStatusStats();

// ä»ç¯å¢ƒå˜é‡è¯»å–ç®¡ç†å‘˜å¯†é’¥
const expectedAdminKey = import.meta.env.ADMIN_ACCESS_KEY || 'admin_2025_weekly';

const metadata = {
    title: 'å†…å®¹å®¡æ ¸ç®¡ç†',
    description: 'ç®¡ç†å’Œå®¡æ ¸å‘¨åˆŠå†…å®¹',
    robots: {
        index: false,
        follow: false
    }
};
---

<Layout metadata={metadata}>
    <!-- å®¢æˆ·ç«¯æƒé™éªŒè¯ -->
    <script define:vars={{expectedAdminKey}}>
        // æ£€æŸ¥ç®¡ç†å‘˜Cookie
        function getCookie(name) {
            // æ–¹æ³•1: åŸå§‹æ–¹æ³•
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                const result = parts.pop();
                const finalValue = result ? result.split(';').shift() || null : null;
                if (finalValue) return finalValue;
            }

            // æ–¹æ³•2: æ›´å¥å£®çš„è§£æ
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const trimmed = cookie.trim();
                if (trimmed.startsWith(`${name}=`)) {
                    const cookieValue = trimmed.substring(name.length + 1);
                    return cookieValue;
                }
            }

            return null;
        }

        const adminKey = getCookie('admin_key');
        const expectedKey = expectedAdminKey;

        // è®¾ç½®ä¸ºå…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
        window.expectedAdminKey = expectedAdminKey;

        if (!adminKey || adminKey !== expectedKey) {
            // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰å¯†é’¥
            const urlParams = new URLSearchParams(window.location.search);
            const urlKey = urlParams.get('key');

            if (urlKey === window.expectedAdminKey) {
                // å°è¯•è®¾ç½®Cookie
                const cookieString = `admin_key=${window.expectedAdminKey}; Max-Age=${60 * 60 * 24}; Path=/`;
                document.cookie = cookieString;
                // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨Cookie
                window.location.href = '/admin/review';
                return;
            }

            // æ²¡æœ‰æƒé™ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
            window.location.href = '/admin/login?return=' + encodeURIComponent('/admin/review');
        }
    </script>

    <div class='bg-gray-50 dark:bg-gray-900 py-8'>
        <div class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8'>
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class='mb-8'>
                <div class='flex items-center justify-between'>
                    <div>
                        <h1 class='text-3xl font-bold text-gray-900 dark:text-white'>å†…å®¹å®¡æ ¸ç®¡ç†</h1>
                        <p class='mt-2 text-gray-600 dark:text-gray-400'>ç®¡ç†å’Œå®¡æ ¸å‘¨åˆŠå†…å®¹çš„å‘å¸ƒçŠ¶æ€</p>
                    </div>
                    <div class='flex space-x-4'>
                        <a
                            href='/admin'
                            class='px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors'>
                            è¿”å›ç®¡ç†
                        </a>
                        <a
                            href='/'
                            class='px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors'>
                            æŸ¥çœ‹ç½‘ç«™
                        </a>
                    </div>
                </div>
            </div>

            <!-- å¯¼èˆªæ ‡ç­¾ -->
            <div class='mb-8'>
                <div class='border-b border-gray-200 dark:border-gray-700'>
                    <nav class='-mb-px flex space-x-8'>
                        <button
                            id='content-tab'
                            class='tab-button py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600 dark:text-blue-400'>
                            å†…å®¹å®¡æ ¸
                        </button>
                        <button
                            id='weekly-tab'
                            class='tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300'>
                            å‘¨åˆŠç®¡ç†
                        </button>
                    </nav>
                </div>
            </div>

            <!-- å†…å®¹å®¡æ ¸é¢æ¿ -->
            <div id='content-panel'>
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class='grid grid-cols-1 md:grid-cols-4 gap-6 mb-8'>
                    {
                        statusStats.map((stat) => {
                            const statusConfig = {
                                draft: {label: 'è‰ç¨¿', color: 'yellow', icon: 'ğŸ“'},
                                published: {label: 'å·²å‘å¸ƒ', color: 'green', icon: 'âœ…'},
                                hidden: {label: 'å·²éšè—', color: 'gray', icon: 'ğŸ‘ï¸'},
                                archived: {label: 'å·²å½’æ¡£', color: 'blue', icon: 'ğŸ“¦'}
                            };
                            const config = statusConfig[stat.status as keyof typeof statusConfig] || {
                                label: stat.status,
                                color: 'gray',
                                icon: 'ğŸ“„'
                            };

                            return (
                                <div
                                    class={`bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border-l-4 border-${config.color}-500`}>
                                    <div class='flex items-center'>
                                        <div class='text-2xl mr-3'>{config.icon}</div>
                                        <div>
                                            <p class='text-sm font-medium text-gray-600 dark:text-gray-400'>
                                                {config.label}
                                            </p>
                                            <p class='text-2xl font-bold text-gray-900 dark:text-white'>{stat.count}</p>
                                        </div>
                                    </div>
                                </div>
                            );
                        })
                    }
                </div>

                <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
                <div
                    class='bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-6'
                    id='batch-toolbar'
                    style='display: none;'>
                    <div class='flex items-center justify-between'>
                        <div class='flex items-center space-x-4'>
                            <span class='text-sm text-gray-600 dark:text-gray-400' id='selected-count'>å·²é€‰æ‹© 0 é¡¹</span
                            >
                            <button id='select-all' class='text-blue-600 hover:text-blue-700 text-sm font-medium'
                                >å…¨é€‰</button
                            >
                            <button id='clear-selection' class='text-gray-600 hover:text-gray-700 text-sm font-medium'
                                >æ¸…é™¤é€‰æ‹©</button
                            >
                        </div>
                        <div class='flex space-x-2'>
                            <button
                                data-action='batch-update'
                                data-status='published'
                                class='px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm'>
                                æ‰¹é‡å‘å¸ƒ
                            </button>
                            <button
                                data-action='batch-update'
                                data-status='hidden'
                                class='px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm'>
                                æ‰¹é‡éšè—
                            </button>
                            <button
                                data-action='batch-update'
                                data-status='archived'
                                class='px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm'>
                                æ‰¹é‡å½’æ¡£
                            </button>
                        </div>
                    </div>
                </div>

                <!-- å†…å®¹è¡¨æ ¼ -->
                <div class='bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden'>
                    <div class='px-6 py-4 border-b border-gray-200 dark:border-gray-700'>
                        <h2 class='text-lg font-semibold text-gray-900 dark:text-white'>
                            å¾…å®¡æ ¸å†…å®¹ ({pendingContent.length})
                        </h2>
                    </div>

                    {
                        pendingContent.length === 0 ? (
                            <div class='text-center py-12'>
                                <div class='text-6xl mb-4'>ğŸ‰</div>
                                <p class='text-xl text-gray-600 dark:text-gray-400'>æ²¡æœ‰å¾…å®¡æ ¸çš„å†…å®¹</p>
                                <p class='text-gray-500 dark:text-gray-500'>æ‰€æœ‰å†…å®¹éƒ½å·²å¤„ç†å®Œæ¯•</p>
                            </div>
                        ) : (
                            <div class='overflow-x-auto'>
                                <table class='min-w-full divide-y divide-gray-200 dark:divide-gray-700'>
                                    <thead class='bg-gray-50 dark:bg-gray-700'>
                                        <tr>
                                            <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-8'>
                                                <input
                                                    type='checkbox'
                                                    id='select-all-header'
                                                    class='w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500'
                                                />
                                            </th>
                                            <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                                æ ‡é¢˜
                                            </th>
                                            <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                                åˆ†ç±»
                                            </th>
                                            <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                                çŠ¶æ€
                                            </th>
                                            <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                                åˆ›å»ºæ—¶é—´
                                            </th>
                                            <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                                å­—æ•°
                                            </th>
                                            <th class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                                æ“ä½œ
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class='bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700'>
                                        {pendingContent.map((content) => {
                                            const statusConfig = {
                                                draft: {
                                                    label: 'è‰ç¨¿',
                                                    bgColor:
                                                        'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'
                                                },
                                                hidden: {
                                                    label: 'å·²éšè—',
                                                    bgColor:
                                                        'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200'
                                                },
                                                archived: {
                                                    label: 'å·²å½’æ¡£',
                                                    bgColor:
                                                        'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
                                                }
                                            };
                                            const config = statusConfig[
                                                content.status as keyof typeof statusConfig
                                            ] || {
                                                label: content.status,
                                                bgColor: 'bg-gray-100 text-gray-800'
                                            };

                                            return (
                                                <tr class='hover:bg-gray-50 dark:hover:bg-gray-700'>
                                                    <td class='px-6 py-4 whitespace-nowrap'>
                                                        <input
                                                            type='checkbox'
                                                            class='content-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500'
                                                            data-content-id={content.id}
                                                        />
                                                    </td>
                                                    <td class='px-6 py-4'>
                                                        <div class='text-sm font-medium text-gray-900 dark:text-white line-clamp-2'>
                                                            {content.title}
                                                        </div>
                                                        {content.description && (
                                                            <div class='text-sm text-gray-500 dark:text-gray-400 line-clamp-1 mt-1'>
                                                                {content.description}
                                                            </div>
                                                        )}
                                                        <div class='text-xs text-gray-400 mt-1'>ID: {content.id}</div>
                                                    </td>
                                                    <td class='px-6 py-4 whitespace-nowrap'>
                                                        {content.category_name && (
                                                            <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'>
                                                                {content.category_name}
                                                            </span>
                                                        )}
                                                    </td>
                                                    <td class='px-6 py-4 whitespace-nowrap'>
                                                        <span
                                                            class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${config.bgColor}`}>
                                                            {config.label}
                                                        </span>
                                                    </td>
                                                    <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400'>
                                                        {new Date(content.created_at).toLocaleDateString('zh-CN')}
                                                    </td>
                                                    <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400'>
                                                        {content.word_count}
                                                    </td>
                                                    <td class='px-6 py-4 whitespace-nowrap text-sm font-medium'>
                                                        <div class='flex space-x-2'>
                                                            <button
                                                                data-action='preview'
                                                                data-content-id={content.id}
                                                                class='text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300'
                                                                title='é¢„è§ˆ'>
                                                                ğŸ‘ï¸
                                                            </button>
                                                            <button
                                                                data-action='update-status'
                                                                data-content-id={content.id}
                                                                data-status='published'
                                                                class='text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300'
                                                                title='å‘å¸ƒ'>
                                                                âœ…
                                                            </button>
                                                            <button
                                                                data-action='update-status'
                                                                data-content-id={content.id}
                                                                data-status='hidden'
                                                                class='text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300'
                                                                title='éšè—'>
                                                                ğŸ‘ï¸â€ğŸ—¨ï¸
                                                            </button>
                                                            <button
                                                                data-action='update-status'
                                                                data-content-id={content.id}
                                                                data-status='archived'
                                                                class='text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300'
                                                                title='å½’æ¡£'>
                                                                ğŸ“¦
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )
                    }
                </div>
            </div>
            <!-- å‘¨åˆŠç®¡ç†é¢æ¿ -->
            <div id='weekly-panel' class='hidden'>
                <!-- å‘¨åˆŠæœŸå·ç®¡ç† -->
                <div class='grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8'>
                    <!-- åˆ›å»ºæ–°æœŸå· -->
                    <div class='bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6'>
                        <h3 class='text-lg font-semibold text-gray-900 dark:text-white mb-4'>ğŸ“… åˆ›å»ºæ–°æœŸå·</h3>
                        <div class='space-y-4'>
                            <div>
                                <label class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'
                                    >æœŸå·æ ‡é¢˜</label
                                >
                                <input
                                    type='text'
                                    id='new-issue-title'
                                    placeholder='ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ'
                                    class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'
                                />
                            </div>
                            <div class='grid grid-cols-2 gap-2'>
                                <div>
                                    <label class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'
                                        >å¼€å§‹æ—¥æœŸ</label
                                    >
                                    <input
                                        type='date'
                                        id='new-issue-start'
                                        class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'
                                    />
                                </div>
                                <div>
                                    <label class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'
                                        >ç»“æŸæ—¥æœŸ</label
                                    >
                                    <input
                                        type='date'
                                        id='new-issue-end'
                                        class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'
                                    />
                                </div>
                            </div>
                            <button
                                id='create-issue-btn'
                                class='w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors'>
                                åˆ›å»ºæœŸå·
                            </button>
                        </div>
                    </div>

                    <!-- æœ€æ–°æœŸå·çŠ¶æ€ -->
                    <div class='bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6'>
                        <h3 class='text-lg font-semibold text-gray-900 dark:text-white mb-4'>ğŸ“Š æœŸå·çŠ¶æ€</h3>
                        <div id='issue-stats' class='space-y-3 min-h-[120px]'>
                            <!-- åˆå§‹å ä½å†…å®¹ -->
                            <div class='flex items-center justify-center py-8'>
                                <div class='text-gray-500 dark:text-gray-400 text-sm text-center'>
                                    <div class='animate-pulse flex space-x-2 justify-center mb-3'>
                                        <div class='h-2 w-2 bg-gray-400 rounded-full'></div>
                                        <div class='h-2 w-2 bg-gray-400 rounded-full'></div>
                                        <div class='h-2 w-2 bg-gray-400 rounded-full'></div>
                                    </div>
                                    <div>ç‚¹å‡»"å‘¨åˆŠç®¡ç†"æ ‡ç­¾æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®</div>
                                </div>
                            </div>
                        </div>
                        <button
                            id='refresh-issues'
                            class='w-full mt-4 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors'>
                            åˆ·æ–°æ•°æ®
                        </button>
                    </div>

                    <!-- å¿«é€Ÿæ“ä½œ -->
                    <div class='bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6'>
                        <h3 class='text-lg font-semibold text-gray-900 dark:text-white mb-4'>âš¡ å¿«é€Ÿæ“ä½œ</h3>
                        <div class='space-y-3'>
                            <button
                                id='auto-suggest-btn'
                                class='w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors'>
                                ğŸ¯ æ™ºèƒ½å»ºè®®å†…å®¹
                            </button>
                            <button
                                id='view-unassociated-btn'
                                class='w-full bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors'>
                                ğŸ“ æŸ¥çœ‹å¾…ç»„ç»‡å†…å®¹
                            </button>
                            <div
                                class='text-sm text-gray-600 dark:text-gray-400 text-center pt-2'
                                id='unassociated-count'>
                                åŠ è½½ä¸­...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å‘¨åˆŠæœŸå·åˆ—è¡¨ -->
                <div class='bg-white dark:bg-gray-800 rounded-xl shadow-sm'>
                    <div class='px-6 py-4 border-b border-gray-200 dark:border-gray-700'>
                        <div class='flex items-center justify-between'>
                            <h3 class='text-lg font-semibold text-gray-900 dark:text-white'>ğŸ“š å‘¨åˆŠæœŸå·ç®¡ç†</h3>
                            <div class='flex space-x-2'>
                                <select
                                    id='status-filter'
                                    class='px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm dark:bg-gray-700 dark:text-white'>
                                    <option value=''>å…¨éƒ¨çŠ¶æ€</option>
                                    <option value='draft'>è‰ç¨¿</option>
                                    <option value='published'>å·²å‘å¸ƒ</option>
                                    <option value='archived'>å·²å½’æ¡£</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class='overflow-x-auto'>
                        <table class='min-w-full divide-y divide-gray-200 dark:divide-gray-700'>
                            <thead class='bg-gray-50 dark:bg-gray-700'>
                                <tr>
                                    <th
                                        class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                        æœŸå·
                                    </th>
                                    <th
                                        class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                        æ ‡é¢˜
                                    </th>
                                    <th
                                        class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                        æ—¶é—´èŒƒå›´
                                    </th>
                                    <th
                                        class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                        å†…å®¹æ•°é‡
                                    </th>
                                    <th
                                        class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                        çŠ¶æ€
                                    </th>
                                    <th
                                        class='px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider'>
                                        æ“ä½œ
                                    </th>
                                </tr>
                            </thead>
                            <tbody
                                id='issues-table-body'
                                class='bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700'>
                                <!-- åˆå§‹åŠ è½½æç¤º -->
                                <tr>
                                    <td colspan='6' class='px-6 py-8 text-center'>
                                        <div class='flex flex-col items-center'>
                                            <div
                                                class='animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mb-4'>
                                            </div>
                                            <div class='text-gray-500 dark:text-gray-400'>åŠ è½½å‘¨åˆŠæœŸå·ä¸­...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class='px-6 py-4 border-t border-gray-200 dark:border-gray-700'>
                        <div class='flex items-center justify-between'>
                            <div class='text-sm text-gray-500 dark:text-gray-400' id='issues-pagination-info'>
                                åŠ è½½ä¸­...
                            </div>
                            <div class='flex space-x-2'>
                                <button
                                    id='issues-prev-page'
                                    class='px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50'
                                    disabled>
                                    ä¸Šä¸€é¡µ
                                </button>
                                <button
                                    id='issues-next-page'
                                    class='px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50'>
                                    ä¸‹ä¸€é¡µ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id='preview-modal' class='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50'>
        <div class='bg-white dark:bg-gray-800 rounded-lg max-w-4xl max-h-[90vh] w-full mx-4 flex flex-col'>
            <div class='px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between'>
                <h3 id='preview-title' class='text-lg font-semibold text-gray-900 dark:text-white'></h3>
                <div class='flex items-center space-x-2'>
                    <button
                        id='toggle-edit-btn'
                        data-action='toggle-edit'
                        class='px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors'>
                        ç¼–è¾‘
                    </button>
                    <button
                        data-action='close-preview'
                        class='text-gray-400 hover:text-gray-600 dark:hover:text-gray-300'>
                        <svg class='w-6 h-6' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                            <path
                                stroke-linecap='round'
                                stroke-linejoin='round'
                                stroke-width='2'
                                d='M6 18L18 6M6 6l12 12'></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class='flex-1 overflow-y-auto'>
                <!-- é¢„è§ˆæ¨¡å¼ -->
                <div
                    id='preview-content'
                    class='px-6 py-4 prose prose-lg max-w-none dark:prose-invert'>
                    <!-- é¢„è§ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>

                <!-- ç¼–è¾‘æ¨¡å¼ -->
                <div id='edit-content' class='px-6 py-4 hidden'>
                    <form id='edit-form' class='space-y-4'>
                        <!-- æ ‡é¢˜ -->
                        <div>
                            <label
                                for='edit-title'
                                class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'>
                                æ ‡é¢˜ *
                            </label>
                            <input
                                type='text'
                                id='edit-title'
                                name='title'
                                required
                                class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'
                            />
                        </div>

                        <!-- æè¿° -->
                        <div>
                            <label
                                for='edit-description'
                                class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'>
                                æè¿°
                            </label>
                            <textarea
                                id='edit-description'
                                name='description'
                                rows='2'
                                class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'
                            ></textarea>
                        </div>

                        <!-- åˆ†ç±»å’ŒçŠ¶æ€ -->
                        <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
                            <div>
                                <label
                                    for='edit-category'
                                    class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'>
                                    åˆ†ç±»
                                </label>
                                <select
                                    id='edit-category'
                                    name='category_id'
                                    class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'>
                                    <option value=''>è¯·é€‰æ‹©åˆ†ç±»</option>
                                    <!-- åˆ†ç±»é€‰é¡¹å°†åœ¨æ­¤åŠ¨æ€æ·»åŠ  -->
                                </select>
                            </div>

                            <div>
                                <label
                                    for='edit-status'
                                    class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'>
                                    çŠ¶æ€
                                </label>
                                <select
                                    id='edit-status'
                                    name='status'
                                    class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'>
                                    <option value='draft'>è‰ç¨¿</option>
                                    <option value='published'>å·²å‘å¸ƒ</option>
                                    <option value='hidden'>å·²éšè—</option>
                                    <option value='archived'>å·²å½’æ¡£</option>
                                </select>
                            </div>
                        </div>

                        <!-- æ—¥æœŸå’Œæˆªå›¾API -->
                        <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
                            <div>
                                <label
                                    for='edit-published-at'
                                    class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'>
                                    å‘å¸ƒæ—¶é—´
                                </label>
                                <input
                                    type='datetime-local'
                                    id='edit-published-at'
                                    name='published_at'
                                    class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'
                                />
                            </div>

                            <div>
                                <label
                                    for='edit-screenshot-api'
                                    class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'>
                                    æˆªå›¾API
                                </label>
                                <select
                                    id='edit-screenshot-api'
                                    name='screenshot_api'
                                    class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'>
                                    <option value='manual'>æ‰‹åŠ¨</option>
                                    <option value='ScreenshotLayer'>ScreenshotLayer</option>
                                    <option value='HCTI'>HCTI</option>
                                </select>
                            </div>
                        </div>

                        <!-- æ¥æºä¿¡æ¯ -->
                        <div>
                            <label
                                for='edit-source'
                                class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'>
                                æ¥æº
                            </label>
                            <input
                                type='text'
                                id='edit-source'
                                name='source'
                                class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'
                            />
                        </div>

                        <!-- æ ‡ç­¾ -->
                        <div>
                            <label
                                for='edit-tags'
                                class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'>
                                æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰
                            </label>
                            <input
                                type='text'
                                id='edit-tags'
                                name='tags'
                                placeholder='ä¾‹å¦‚ï¼šå‰ç«¯,React,JavaScript'
                                class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'
                            />
                        </div>

                        <!-- é«˜çº§è®¾ç½®ï¼ˆå¯æŠ˜å ï¼‰ -->
                        <div class='border-t border-gray-200 dark:border-gray-700 pt-4'>
                            <button
                                type='button'
                                id='toggle-advanced'
                                class='flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white mb-4'>
                                <span>é«˜çº§è®¾ç½®</span>
                                <svg
                                    class='w-4 h-4 ml-1 transform transition-transform'
                                    id='advanced-arrow'
                                    fill='none'
                                    viewBox='0 0 24 24'>
                                    <path
                                        stroke='currentColor'
                                        stroke-linecap='round'
                                        stroke-linejoin='round'
                                        stroke-width='2'
                                        d='M6 9l6 6 6-6'></path>
                                </svg>
                            </button>

                            <div id='advanced-fields' class='hidden space-y-4'>
                                <!-- SEOå­—æ®µ -->
                                <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
                                    <div>
                                        <label
                                            for='edit-meta-title'
                                            class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'>
                                            SEOæ ‡é¢˜
                                        </label>
                                        <input
                                            type='text'
                                            id='edit-meta-title'
                                            name='meta_title'
                                            class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'
                                        />
                                    </div>

                                    <div>
                                        <label
                                            for='edit-sort-order'
                                            class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'>
                                            æ’åºæƒé‡
                                        </label>
                                        <input
                                            type='number'
                                            id='edit-sort-order'
                                            name='sort_order'
                                            min='0'
                                            class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'
                                        />
                                    </div>
                                </div>

                                <!-- SEOæè¿° -->
                                <div>
                                    <label
                                        for='edit-meta-description'
                                        class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'>
                                        SEOæè¿°
                                    </label>
                                    <textarea
                                        id='edit-meta-description'
                                        name='meta_description'
                                        rows='2'
                                        class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white'
                                    ></textarea>
                                </div>

                                <!-- æ¨èæ ‡è®° -->
                                <div class='flex items-center'>
                                    <input
                                        type='checkbox'
                                        id='edit-featured'
                                        name='featured'
                                        class='w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600'
                                    />
                                    <label
                                        for='edit-featured'
                                        class='ml-2 text-sm font-medium text-gray-700 dark:text-gray-300'>
                                        æ ‡è®°ä¸ºæ¨èå†…å®¹
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- å†…å®¹ -->
                        <div>
                            <label
                                for='edit-content-text'
                                class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1'>
                                å†…å®¹ *
                            </label>
                            <textarea
                                id='edit-content-text'
                                name='content'
                                required
                                rows='12'
                                placeholder='æ”¯æŒMarkdownæ ¼å¼'
                                class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white font-mono text-sm'
                            ></textarea>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class='flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700'>
                            <button
                                type='button'
                                data-action='cancel-edit'
                                class='px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors'>
                                å–æ¶ˆ
                            </button>
                            <button
                                type='button'
                                data-action='save-content'
                                class='px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors'>
                                ä¿å­˜
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id='loading-overlay' class='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50'>
        <div class='bg-white dark:bg-gray-800 rounded-lg p-6 flex items-center space-x-3'>
            <div class='animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600'></div>
            <span class='text-gray-900 dark:text-white font-medium'>å¤„ç†ä¸­...</span>
        </div>
    </div>

    <script is:inline>
        // å…¨å±€å˜é‡
        let currentContentId = null;
        let currentContentData = null;
        let editOptions = null;
        let isEditMode = false;

        // é€šç”¨çš„ Cookie è·å–å‡½æ•°
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                const result = parts.pop();
                return result ? result.split(';').shift() || null : null;
            }
            return null;
        }

        // æ›´æ–°æ‰¹é‡æ“ä½œå·¥å…·æ 
        function updateBatchToolbar() {
            const checkboxes = document.querySelectorAll('.content-checkbox:checked');
            const toolbar = document.getElementById('batch-toolbar');
            const counter = document.getElementById('selected-count');

            if (toolbar && counter) {
                if (checkboxes.length > 0) {
                    toolbar.style.display = 'block';
                    counter.textContent = `å·²é€‰æ‹© ${checkboxes.length} é¡¹`;
                } else {
                    toolbar.style.display = 'none';
                }
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.remove('hidden');
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.add('hidden');
        }

        // æ¸²æŸ“é¢„è§ˆå†…å®¹
        function renderPreviewContent(content, contentEl) {
            if (!contentEl) return;

            // æ”¹è¿›çš„ Markdown è½¬ HTML
            let htmlContent = content.content
                .replace(
                    /^### (.*$)/gim,
                    '<h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">$1</h3>'
                )
                .replace(/^## (.*$)/gim, '<h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">$1</h1>')
                .replace(
                    /!\[([^\]]*)\]\(([^)]+)\)/gim,
                    '<img src="$2" alt="$1" class="max-w-full h-auto rounded-lg shadow-sm mb-4" />'
                )
                .replace(
                    /\[([^\]]+)\]\(([^)]+)\)/gim,
                    '<a href="$2" target="_blank" rel="noopener" class="text-blue-600 dark:text-blue-400 hover:underline">$1</a>'
                )
                .replace(
                    /`([^`]+)`/gim,
                    '<code class="bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded text-sm">$1</code>'
                )
                .replace(/\*\*(.*?)\*\*/gim, '<strong class="font-semibold">$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em class="italic">$1</em>')
                .replace(/^- (.*$)/gim, '<li class="mb-1">$1</li>')
                .replace(/^\* (.*$)/gim, '<li class="mb-1">$1</li>');

            // å¤„ç†æ®µè½
            const paragraphs = htmlContent
                .split('\n\n')
                .map((p) => p.trim())
                .filter((p) => p);
            htmlContent = paragraphs
                .map((p) => {
                    if (p.startsWith('<h') || p.startsWith('<img') || p.includes('<li')) {
                        return p;
                    }
                    return `<p class="mb-4 text-gray-700 dark:text-gray-300 leading-relaxed">${p.replace(/\n/g, '<br>')}</p>`;
                })
                .join('');

            // åŒ…è£…åˆ—è¡¨é¡¹
            htmlContent = htmlContent.replace(/(<li[^>]*>.*?<\/li>)/gs, (match, group) => {
                if (!match.includes('<ul') && !match.includes('<ol')) {
                    return `<ul class="list-disc pl-6 mb-4">${group}</ul>`;
                }
                return group;
            });

            // æ¸²æŸ“ä¸»è¦å†…å®¹
            let finalContent = htmlContent;

            // æ·»åŠ æ ‡ç­¾æ˜¾ç¤º
            if (content.tags && content.tags.length > 0) {
                const tagsHtml = content.tags
                    .map(
                        (tag) =>
                            `<span class="inline-block px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs rounded-full mr-2 mb-2">${tag}</span>`
                    )
                    .join('');

                finalContent = `
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æ ‡ç­¾</h4>
                        <div class="flex flex-wrap">${tagsHtml}</div>
                    </div>
                    ${finalContent}
                `;
            }

            // æ·»åŠ åˆ†ç±»æ˜¾ç¤º
            if (content.category_name) {
                finalContent = `
                    <div class="mb-4">
                        <span class="inline-flex items-center px-3 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-sm font-medium rounded-full">
                            ${content.category_name}
                        </span>
                    </div>
                    ${finalContent}
                `;
            }

            contentEl.innerHTML = finalContent;
        }

        // è·å–ç¼–è¾‘é€‰é¡¹ï¼ˆåˆ†ç±»ã€æ ‡ç­¾ç­‰ï¼‰
        async function loadEditOptions() {
            if (editOptions) return editOptions; // ç¼“å­˜é€‰é¡¹

            try {
                const adminKey = getCookie('admin_key');
                const headerKey = adminKey || window.expectedAdminKey || '';

                const response = await fetch('/api/admin/get-options', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-key': headerKey
                    }
                });

                const result = await response.json();
                if (result.success && result.data) {
                    editOptions = result.data;
                    return editOptions;
                }
            } catch (error) {
                console.error('Failed to load edit options:', error);
            }
            return null;
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        async function showPreview(id) {
            const modal = document.getElementById('preview-modal');
            const titleEl = document.getElementById('preview-title');
            const contentEl = document.getElementById('preview-content');

            if (!modal || !titleEl || !contentEl) {
                return;
            }

            currentContentId = id;
            showLoading();

            try {
                // è·å–è®¤è¯ä¿¡æ¯
                const adminKey = getCookie('admin_key');
                const headerKey = adminKey || window.expectedAdminKey || '';

                // å¹¶è¡ŒåŠ è½½å†…å®¹å’Œç¼–è¾‘é€‰é¡¹
                const [contentResponse, options] = await Promise.all([
                    fetch(`/api/admin/preview-content?id=${id}`, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-admin-key': headerKey
                        }
                    }),
                    loadEditOptions()
                ]);

                const result = await contentResponse.json();

                if (result.success && result.data) {
                    const content = result.data;
                    currentContentData = content;
                    titleEl.textContent = content.title;

                    // æ¸²æŸ“é¢„è§ˆå†…å®¹
                    renderPreviewContent(content, contentEl);

                    // ç¡®ä¿åœ¨é¢„è§ˆæ¨¡å¼
                    setPreviewMode();
                    modal.classList.remove('hidden');
                } else {
                    alert('è·å–å†…å®¹å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('è·å–å†…å®¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                hideLoading();
            }
        }

        // è®¾ç½®é¢„è§ˆæ¨¡å¼
        function setPreviewMode() {
            isEditMode = false;
            const previewContent = document.getElementById('preview-content');
            const editContent = document.getElementById('edit-content');
            const toggleBtn = document.getElementById('toggle-edit-btn');

            if (previewContent && editContent && toggleBtn) {
                previewContent.classList.remove('hidden');
                editContent.classList.add('hidden');
                toggleBtn.textContent = 'ç¼–è¾‘';
            }
        }

        // è®¾ç½®ç¼–è¾‘æ¨¡å¼
        function setEditMode() {
            isEditMode = true;
            const previewContent = document.getElementById('preview-content');
            const editContent = document.getElementById('edit-content');
            const toggleBtn = document.getElementById('toggle-edit-btn');

            if (previewContent && editContent && toggleBtn) {
                previewContent.classList.add('hidden');
                editContent.classList.remove('hidden');
                toggleBtn.textContent = 'é¢„è§ˆ';

                // å¡«å……ç¼–è¾‘è¡¨å•
                populateEditForm();
            }
        }

        // å¡«å……ç¼–è¾‘è¡¨å•
        async function populateEditForm() {
            if (!currentContentData || !editOptions) return;

            const form = document.getElementById('edit-form');
            if (!form) return;

            // å¡«å……åŸºæœ¬å­—æ®µ
            const titleInput = document.getElementById('edit-title');
            const descriptionInput = document.getElementById('edit-description');
            const contentInput = document.getElementById('edit-content-text');
            const sourceInput = document.getElementById('edit-source');
            const statusSelect = document.getElementById('edit-status');
            const categorySelect = document.getElementById('edit-category');
            const publishedAtInput = document.getElementById('edit-published-at');
            const screenshotApiSelect = document.getElementById('edit-screenshot-api');

            if (titleInput) titleInput.value = currentContentData.title || '';
            if (descriptionInput) descriptionInput.value = currentContentData.description || '';
            if (contentInput) contentInput.value = currentContentData.content || '';
            if (sourceInput) sourceInput.value = currentContentData.source || '';
            if (statusSelect) statusSelect.value = currentContentData.status || 'draft';
            if (screenshotApiSelect) screenshotApiSelect.value = currentContentData.screenshot_api || 'manual';

            // å¤„ç†å‘å¸ƒæ—¶é—´
            if (publishedAtInput && currentContentData.published_at) {
                // è½¬æ¢æ•°æ®åº“æ—¶é—´æ ¼å¼ä¸º datetime-local æ ¼å¼
                const publishedDate = new Date(currentContentData.published_at);
                const localDateTime = publishedDate.toISOString().slice(0, 16);
                publishedAtInput.value = localDateTime;
            }

            // å¡«å……åˆ†ç±»é€‰é¡¹
            if (categorySelect && editOptions.categories) {
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                categorySelect.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>';

                // æ·»åŠ åˆ†ç±»é€‰é¡¹
                editOptions.categories.forEach((category) => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    if (category.id === currentContentData.category_id) {
                        option.selected = true;
                    }
                    categorySelect.appendChild(option);
                });
            }

            // å¡«å……æ ‡ç­¾
            const tagsInput = document.getElementById('edit-tags');
            if (tagsInput && currentContentData.tags) {
                tagsInput.value = currentContentData.tags.join(', ');
            }

            // å¡«å……é«˜çº§å­—æ®µ
            const metaTitleInput = document.getElementById('edit-meta-title');
            const metaDescriptionInput = document.getElementById('edit-meta-description');
            const sortOrderInput = document.getElementById('edit-sort-order');
            const featuredCheckbox = document.getElementById('edit-featured');

            if (metaTitleInput) metaTitleInput.value = currentContentData.meta_title || '';
            if (metaDescriptionInput) metaDescriptionInput.value = currentContentData.meta_description || '';
            if (sortOrderInput) sortOrderInput.value = currentContentData.sort_order || 0;
            if (featuredCheckbox) featuredCheckbox.checked = currentContentData.featured || false;
        }

        // åˆ‡æ¢ç¼–è¾‘/é¢„è§ˆæ¨¡å¼
        function toggleEditMode() {
            if (isEditMode) {
                setPreviewMode();
            } else {
                setEditMode();
            }
        }

        // ä¿å­˜å†…å®¹
        async function saveContent() {
            const form = document.getElementById('edit-form');
            if (!form || !currentContentId) return;

            // è·å–è¡¨å•æ•°æ®
            const formData = new FormData(form);
            const contentData = {
                title: formData.get('title'),
                description: formData.get('description'),
                content: formData.get('content'),
                category_id: formData.get('category_id') ? parseInt(formData.get('category_id')) : null,
                source: formData.get('source'),
                status: formData.get('status'),
                published_at: formData.get('published_at'),
                screenshot_api: formData.get('screenshot_api'),
                meta_title: formData.get('meta_title'),
                meta_description: formData.get('meta_description'),
                sort_order: formData.get('sort_order') ? parseInt(formData.get('sort_order')) : 0,
                featured: formData.get('featured') === 'on'
            };

            // å¤„ç†æ ‡ç­¾
            const tagsString = formData.get('tags');
            const tags = tagsString
                ? tagsString
                      .split(',')
                      .map((tag) => tag.trim())
                      .filter((tag) => tag)
                : [];

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!contentData.title || !contentData.content) {
                alert('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }

            showLoading();

            try {
                const adminKey = getCookie('admin_key');
                const headerKey = adminKey || window.expectedAdminKey || '';

                const response = await fetch('/api/admin/update-content', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-key': headerKey
                    },
                    body: JSON.stringify({
                        id: currentContentId,
                        contentData: contentData,
                        tags: tags
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('å†…å®¹ä¿å­˜æˆåŠŸ');
                    // é‡æ–°åŠ è½½å†…å®¹å¹¶åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
                    await showPreview(currentContentId);
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                hideLoading();
            }
        }

        // å…³é—­é¢„è§ˆ
        function closePreview() {
            const modal = document.getElementById('preview-modal');
            const toggleBtn = document.getElementById('toggle-edit-btn');
            
            if (modal) {
                modal.classList.add('hidden');
                // é‡ç½®çŠ¶æ€
                currentContentId = null;
                currentContentData = null;
                isEditMode = false;
                
                // é‡æ–°æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®ï¼ˆä¸ºå†…å®¹é¢„è§ˆå‡†å¤‡ï¼‰
                if (toggleBtn) {
                    toggleBtn.style.display = '';
                }
            }
        }

        // æ˜¾ç¤ºå‘¨åˆŠé¢„è§ˆ
        async function showWeeklyPreview(issueId) {
            const modal = document.getElementById('preview-modal');
            const titleEl = document.getElementById('preview-title');
            const contentEl = document.getElementById('preview-content');
            const editContent = document.getElementById('edit-content');
            const toggleBtn = document.getElementById('toggle-edit-btn');

            if (!modal || !titleEl || !contentEl) {
                return;
            }

            showLoading();

            try {
                const adminKey = getCookie('admin_key') || window.expectedAdminKey || '';
                
                // è°ƒç”¨çœŸå®APIè·å–æœŸå·è¯¦æƒ…
                const response = await fetch(`/api/admin/weekly/issue-detail?id=${issueId}&admin_key=${encodeURIComponent(adminKey)}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-key': adminKey
                    }
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'è·å–æœŸå·è¯¦æƒ…å¤±è´¥');
                }

                const weeklyData = result.data;
                const issue = weeklyData.issue;
                const sections = weeklyData.sections || [];

                titleEl.textContent = issue.title;

                // éšè—ç¼–è¾‘ç›¸å…³æŒ‰é’®ï¼Œå› ä¸ºå‘¨åˆŠé¢„è§ˆä¸éœ€è¦ç¼–è¾‘åŠŸèƒ½
                if (editContent) editContent.classList.add('hidden');
                if (toggleBtn) toggleBtn.style.display = 'none';

                // ä½¿ç”¨ SinglePost.astro çš„æ ·å¼æ¸²æŸ“å‘¨åˆŠé¢„è§ˆ
                const statusConfig = {
                    draft: { label: 'è‰ç¨¿', bgColor: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100' },
                    published: { label: 'å·²å‘å¸ƒ', bgColor: 'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100' },
                    archived: { label: 'å·²å½’æ¡£', bgColor: 'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100' }
                };

                const currentStatus = statusConfig[issue.status] || statusConfig.draft;

                const weeklyPreviewHtml = `
                    <article class="py-6 sm:py-8 rounded-xl">
                        <!-- å‘¨åˆŠå¤´éƒ¨ä¿¡æ¯ -->
                        <header class="space-y-6 mb-8">
                            <div class="space-y-4">
                                <div class="flex flex-wrap gap-4 text-sm text-gray-600 dark:text-gray-400">
                                    <span class="flex items-center gap-2 px-3 py-1.5 bg-gray-100/80 dark:bg-gray-800/50 rounded-full">
                                        ğŸ“… ${formatDateOnly(issue.start_date)} ~ ${formatDateOnly(issue.end_date)}
                                    </span>
                                    <span class="flex items-center gap-2 px-3 py-1.5 bg-gray-100/80 dark:bg-gray-800/50 rounded-full">
                                        ğŸ“ ${issue.total_items} æ¡å†…å®¹
                                    </span>
                                    <span class="flex items-center gap-2 px-3 py-1.5 bg-gray-100/80 dark:bg-gray-800/50 rounded-full">
                                        ğŸ“Š ${formatNumber(issue.total_word_count)} å­—
                                    </span>
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${currentStatus.bgColor}">
                                        ${currentStatus.label}
                                    </span>
                                </div>
                                ${issue.description ? `
                                    <p class="text-gray-600 dark:text-gray-400 text-base leading-relaxed">${issue.description}</p>
                                ` : ''}
                            </div>
                        </header>

                        <!-- å†…å®¹åŒºåŸŸ -->
                        <div class="space-y-8">
                            ${sections.length > 0 ? sections.map((section, index) => {
                                const categoryStyle = getCategoryStyle(section.category);
                                return `
                                    <section class="p-8 rounded-xl border border-gray-200/70 dark:border-gray-700/40 transition-all duration-300 bg-white/80 dark:bg-gray-800/30 hover:border-gray-300 dark:hover:border-gray-600 hover:shadow-lg dark:hover:shadow-gray-900/30 backdrop-blur-sm">
                                        <!-- åˆ†ç±»ä¸æ¥æº -->
                                        <div class="flex justify-between items-center mb-5 text-sm">
                                            <span class="px-3 py-1.5 rounded-full font-medium flex items-center gap-1.5 ${categoryStyle.bg} ${categoryStyle.text}">
                                                <span class="text-base">${categoryStyle.icon}</span>
                                                ${section.category}
                                            </span>
                                            ${section.source ? `
                                                <a href="${section.source}" target="_blank" rel="noopener noreferrer" 
                                                   class="text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 flex items-center transition-colors group">
                                                    <span class="mr-1.5 group-hover:underline">æ¥æº</span>
                                                    <span class="text-xs">ğŸ”—</span>
                                                </a>
                                            ` : ''}
                                        </div>
                                        
                                        <!-- å†…å®¹æ ‡é¢˜ -->
                                        ${section.title ? `
                                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">${section.title}</h3>
                                        ` : ''}
                                        
                                        <!-- æè¿° -->
                                        ${section.description ? `
                                            <p class="text-gray-600 dark:text-gray-400 mb-4">${section.description}</p>
                                        ` : ''}
                                        
                                        <!-- æ ‡ç­¾ -->
                                        ${section.tags && section.tags.length > 0 ? `
                                            <div class="mb-6">
                                                <div class="flex flex-wrap gap-2">
                                                    ${section.tags.map(tag => `
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                                            ${tag}
                                                        </span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        <!-- å†…å®¹ -->
                                        <div class="prose prose-lg max-w-none dark:prose-invert">
                                            ${renderMarkdown(section.content)}
                                        </div>
                                    </section>
                                `;
                            }).join('') : `
                                <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                                    <div class="text-6xl mb-4">ğŸ“</div>
                                    <h3 class="text-xl font-medium mb-2">æš‚æ— å†…å®¹</h3>
                                    <p class="text-sm">è¿™æœŸå‘¨åˆŠè¿˜æ²¡æœ‰å…³è”ä»»ä½•å†…å®¹</p>
                                    ${issue.status === 'draft' ? '<p class="text-sm mt-2">è¯·å…ˆå…³è”å†…å®¹åˆ°æ­¤æœŸå·</p>' : ''}
                                </div>
                            `}
                        </div>
                    </article>
                `;

                contentEl.innerHTML = weeklyPreviewHtml;
                modal.classList.remove('hidden');

            } catch (error) {
                console.error('è·å–å‘¨åˆŠè¯¦æƒ…å¤±è´¥:', error);
                
                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œæ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
                if (error.message.includes('Unauthorized')) {
                    alert('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = '/admin/login?return=' + encodeURIComponent('/admin/review');
                } else {
                    alert('è·å–å‘¨åˆŠè¯¦æƒ…å¤±è´¥: ' + error.message);
                }
            } finally {
                hideLoading();
            }
        }

        // æ›´æ–°å•ä¸ªå†…å®¹çŠ¶æ€
        async function updateContentStatus(id, status) {
            if (!confirm(`ç¡®å®šè¦å°†å†…å®¹çŠ¶æ€æ›´æ”¹ä¸º"${status}"å—ï¼Ÿ`)) {
                return;
            }

            showLoading();

            try {
                // è·å–è®¤è¯ä¿¡æ¯
                const adminKey = getCookie('admin_key');

                // å¦‚æœæ²¡æœ‰è®¤è¯ä¿¡æ¯ï¼Œå¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•
                if (!adminKey && !window.expectedAdminKey) {
                    alert('ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = '/admin/login?return=' + encodeURIComponent('/admin/review');
                    return;
                }

                const response = await fetch('/api/admin/update-status', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-key': adminKey || window.expectedAdminKey || ''
                    },
                    body: JSON.stringify({id, status})
                });

                const result = await response.json();

                if (result.success) {
                    window.location.reload();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                hideLoading();
            }
        }

        // æ‰¹é‡æ›´æ–°çŠ¶æ€
        async function batchUpdateStatus(status) {
            const checkboxes = document.querySelectorAll('.content-checkbox:checked');
            const ids = Array.from(checkboxes)
                .map((cb) => parseInt(cb.getAttribute('data-content-id') || '0'))
                .filter((id) => id > 0);

            if (ids.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„å†…å®¹');
                return;
            }

            if (!confirm(`ç¡®å®šè¦å°† ${ids.length} é¡¹å†…å®¹çŠ¶æ€æ›´æ”¹ä¸º"${status}"å—ï¼Ÿ`)) {
                return;
            }

            showLoading();

            try {
                // è·å–è®¤è¯ä¿¡æ¯
                const adminKey = getCookie('admin_key');

                // å¦‚æœæ²¡æœ‰è®¤è¯ä¿¡æ¯ï¼Œå¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•
                if (!adminKey && !window.expectedAdminKey) {
                    alert('ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = '/admin/login?return=' + encodeURIComponent('/admin/review');
                    return;
                }

                const response = await fetch('/api/admin/batch-update-status', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-key': adminKey || window.expectedAdminKey || ''
                    },
                    body: JSON.stringify({ids, status})
                });

                const result = await response.json();

                if (result.success) {
                    window.location.reload();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                hideLoading();
            }
        }

        // äº‹ä»¶å§”æ‰˜å¤„ç†æ‰€æœ‰æŒ‰é’®ç‚¹å‡»
        function handleButtonClick(event) {
            const button = event.target.closest('button[data-action]');
            if (!button) return;

            const action = button.getAttribute('data-action');
            const contentId = button.getAttribute('data-content-id');
            const issueId = button.getAttribute('data-issue-id');
            const status = button.getAttribute('data-status');

            switch (action) {
                case 'preview':
                    if (contentId) {
                        showPreview(parseInt(contentId));
                    }
                    break;
                case 'preview-weekly':
                    if (issueId) {
                        showWeeklyPreview(parseInt(issueId));
                    }
                    break;
                case 'update-status':
                    if (contentId && status) {
                        updateContentStatus(parseInt(contentId), status);
                    }
                    break;
                case 'batch-update':
                    if (status) {
                        batchUpdateStatus(status);
                    }
                    break;
                case 'close-preview':
                    closePreview();
                    break;
                case 'toggle-edit':
                    toggleEditMode();
                    break;
                case 'cancel-edit':
                    setPreviewMode();
                    break;
                case 'save-content':
                    saveContent();
                    break;
            }
        }

        // åˆ‡æ¢é«˜çº§è®¾ç½®æ˜¾ç¤º
        function toggleAdvancedSettings() {
            const advancedFields = document.getElementById('advanced-fields');
            const advancedArrow = document.getElementById('advanced-arrow');

            if (advancedFields && advancedArrow) {
                if (advancedFields.classList.contains('hidden')) {
                    advancedFields.classList.remove('hidden');
                    advancedArrow.style.transform = 'rotate(180deg)';
                } else {
                    advancedFields.classList.add('hidden');
                    advancedArrow.style.transform = 'rotate(0deg)';
                }
            }
        }

        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–äº‹ä»¶
        // å‘¨åˆŠç®¡ç†åŠŸèƒ½
        let currentIssuesPage = 0;
        let currentUnassociatedPage = 0;
        const issuesPerPage = 20;
        const unassociatedPerPage = 50;

        // æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
        function initTabs() {
            const contentTab = document.getElementById('content-tab');
            const weeklyTab = document.getElementById('weekly-tab');
            const contentPanel = document.getElementById('content-panel');
            const weeklyPanel = document.getElementById('weekly-panel');

            contentTab.addEventListener('click', () => {
                setActiveTab('content');
            });

            weeklyTab.addEventListener('click', () => {
                setActiveTab('weekly');
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œå¦‚æœæ˜¯åˆ™åŠ è½½æ•°æ®
                if (!weeklyTab.dataset.loaded) {
                    weeklyTab.dataset.loaded = 'true';
                    loadWeeklyDashboard();
                }
            });
        }

        function setActiveTab(tab) {
            const contentTab = document.getElementById('content-tab');
            const weeklyTab = document.getElementById('weekly-tab');
            const contentPanel = document.getElementById('content-panel');
            const weeklyPanel = document.getElementById('weekly-panel');

            if (tab === 'content') {
                contentTab.className =
                    'tab-button py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600 dark:text-blue-400';
                weeklyTab.className =
                    'tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300';
                contentPanel.classList.remove('hidden');
                weeklyPanel.classList.add('hidden');
            } else {
                weeklyTab.className =
                    'tab-button py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600 dark:text-blue-400';
                contentTab.className =
                    'tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300';
                weeklyPanel.classList.remove('hidden');
                contentPanel.classList.add('hidden');
            }
        }

        // å‘¨åˆŠç®¡ç†é¢æ¿åˆå§‹åŒ–
        async function loadWeeklyDashboard() {
            try {
                await Promise.all([loadIssueStats(), loadIssuesList(), loadUnassociatedCount()]);
            } catch (error) {
                console.error('åŠ è½½å‘¨åˆŠç®¡ç†é¢æ¿å¤±è´¥:', error);
                // å°è¯•ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                console.log('APIä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å±•ç¤ºç•Œé¢');
                loadMockData();
                showErrorMessage('APIæœåŠ¡ä¸å¯ç”¨ï¼Œå½“å‰æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®ã€‚è¯·ç¡®ä¿æœåŠ¡å™¨æ­£å¸¸è¿è¡Œã€‚');
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showErrorMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // å¼€å‘æ¨¡å¼ï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        function loadMockData() {
            console.log('åŠ è½½æ¨¡æ‹Ÿæ•°æ®...');

            // æ¨¡æ‹ŸæœŸå·ç»Ÿè®¡
            const statsContainer = document.getElementById('issue-stats');
            statsContainer.innerHTML = `
                <div class="flex items-center justify-between py-2 px-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex items-center">
                        <span class="text-lg mr-2">ğŸ“</span>
                        <span class="text-sm text-gray-700 dark:text-gray-300">è‰ç¨¿</span>
                    </div>
                    <span class="text-sm font-semibold text-gray-900 dark:text-white">2</span>
                </div>
                <div class="flex items-center justify-between py-2 px-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex items-center">
                        <span class="text-lg mr-2">âœ…</span>
                        <span class="text-sm text-gray-700 dark:text-gray-300">å·²å‘å¸ƒ</span>
                    </div>
                    <span class="text-sm font-semibold text-gray-900 dark:text-white">45</span>
                </div>
            `;

            // æ¨¡æ‹Ÿå¾…ç»„ç»‡å†…å®¹æ•°é‡
            const countDiv = document.getElementById('unassociated-count');
            countDiv.textContent = 'å¾…ç»„ç»‡å†…å®¹: 12 æ¡';
            countDiv.className = 'text-sm text-gray-600 dark:text-gray-400 text-center pt-2';

            // æ¨¡æ‹ŸæœŸå·åˆ—è¡¨
            const tbody = document.getElementById('issues-table-body');
            tbody.innerHTML = `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                        ç¬¬ 46 æœŸ
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                        æˆ‘ä¸çŸ¥é“çš„å‘¨åˆŠç¬¬ 46 æœŸ
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        2025-01-20 ~ 2025-01-26
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        0 æ¡ / 0 å­—
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100">
                            è‰ç¨¿
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex space-x-2">
                            <button onclick="alert('æ¨¡æ‹Ÿæ•°æ®ï¼šé¢„è§ˆåŠŸèƒ½')" class="text-purple-600 hover:text-purple-900 dark:text-purple-400" title="é¢„è§ˆ">
                                ğŸ‘ï¸
                            </button>
                            <button onclick="alert('æ¨¡æ‹Ÿæ•°æ®ï¼šå…³è”å†…å®¹åŠŸèƒ½')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400" title="å…³è”å†…å®¹">
                                ğŸ”—
                            </button>
                            <button onclick="alert('æ¨¡æ‹Ÿæ•°æ®ï¼šå‘å¸ƒåŠŸèƒ½')" class="text-green-600 hover:text-green-900 dark:text-green-400" title="å‘å¸ƒ">
                                ğŸ“¤
                            </button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                        ç¬¬ 45 æœŸ
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                        æˆ‘ä¸çŸ¥é“çš„å‘¨åˆŠç¬¬ 45 æœŸ
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        2025-01-13 ~ 2025-01-19
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        12 æ¡ / 8,500 å­—
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100">
                            å·²å‘å¸ƒ
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex space-x-2">
                            <button onclick="alert('æ¨¡æ‹Ÿæ•°æ®ï¼šé¢„è§ˆåŠŸèƒ½')" class="text-purple-600 hover:text-purple-900 dark:text-purple-400" title="é¢„è§ˆ">
                                ğŸ‘ï¸
                            </button>
                        </div>
                    </td>
                </tr>
            `;

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            document.getElementById('issues-pagination-info').textContent = 'æ˜¾ç¤º 1-2 é¡¹ï¼Œå…± 47 é¡¹ (æ¨¡æ‹Ÿæ•°æ®)';

            // æ·»åŠ æ¨¡æ‹Ÿæ•°æ®æç¤º
            const refreshBtn = document.getElementById('refresh-issues');
            refreshBtn.textContent = 'ğŸ”„ ç‚¹å‡»é‡è¯•è¿æ¥API';
            refreshBtn.className =
                'w-full mt-4 bg-orange-500 dark:bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-600 dark:hover:bg-orange-700 transition-colors';
        }

        // åŠ è½½æœŸå·ç»Ÿè®¡
        async function loadIssueStats() {
            const statsContainer = document.getElementById('issue-stats');

            try {
                const adminKey = getCookie('admin_key') || window.expectedAdminKey;
                const response = await fetch('/api/admin/weekly/issues?admin_key=' + encodeURIComponent(adminKey));
                const result = await response.json();

                if (result.success && result.data.status_stats && result.data.status_stats.length > 0) {
                    statsContainer.innerHTML = '';

                    result.data.status_stats.forEach((stat) => {
                        const statusConfig = {
                            draft: {label: 'è‰ç¨¿', color: 'yellow', icon: 'ğŸ“'},
                            published: {label: 'å·²å‘å¸ƒ', color: 'green', icon: 'âœ…'},
                            archived: {label: 'å·²å½’æ¡£', color: 'blue', icon: 'ğŸ“¦'}
                        };

                        const config = statusConfig[stat.status] || {label: stat.status, color: 'gray', icon: 'ğŸ“„'};

                        const statDiv = document.createElement('div');
                        statDiv.className =
                            'flex items-center justify-between py-2 px-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
                        statDiv.innerHTML = `
                            <div class="flex items-center">
                                <span class="text-lg mr-2">${config.icon}</span>
                                <span class="text-sm text-gray-700 dark:text-gray-300">${config.label}</span>
                            </div>
                            <span class="text-sm font-semibold text-gray-900 dark:text-white">${stat.count}</span>
                        `;
                        statsContainer.appendChild(statDiv);
                    });
                } else {
                    // æ˜¾ç¤ºç©ºçŠ¶æ€
                    statsContainer.innerHTML = `
                        <div class="text-center py-4">
                            <div class="text-gray-500 dark:text-gray-400 text-sm">
                                ğŸ“„ æš‚æ— æœŸå·æ•°æ®
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½æœŸå·ç»Ÿè®¡å¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                statsContainer.innerHTML = `
                    <div class="text-center py-4">
                        <div class="text-red-500 dark:text-red-400 text-sm">
                            âŒ åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•
                        </div>
                    </div>
                `;
            }
        }

        // åŠ è½½æœŸå·åˆ—è¡¨
        async function loadIssuesList() {
            const tbody = document.getElementById('issues-table-body');

            try {
                const adminKey = getCookie('admin_key') || window.expectedAdminKey;
                const statusFilter = document.getElementById('status-filter').value;
                const params = new URLSearchParams({
                    admin_key: adminKey,
                    limit: issuesPerPage.toString(),
                    offset: (currentIssuesPage * issuesPerPage).toString()
                });

                if (statusFilter) {
                    params.append('status', statusFilter);
                }

                const response = await fetch('/api/admin/weekly/issues?' + params.toString());
                const result = await response.json();

                if (result.success) {
                    renderIssuesList(result.data.issues);
                    updateIssuesPagination(result.data.pagination);
                } else {
                    throw new Error(result.error || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æœŸå·åˆ—è¡¨å¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center">
                            <div class="text-red-500 dark:text-red-400">
                                âŒ åŠ è½½å¤±è´¥: ${error.message}
                            </div>
                        </td>
                    </tr>
                `;

                // é‡ç½®åˆ†é¡µä¿¡æ¯
                document.getElementById('issues-pagination-info').textContent = 'åŠ è½½å¤±è´¥';
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸï¼Œåªæ˜¾ç¤ºå¹´æœˆæ—¥
        function formatDateOnly(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(date.getTime())) return dateString;
                // è¿”å› YYYY-MM-DD æ ¼å¼
                return date.toISOString().split('T')[0];
            } catch (error) {
                console.warn('æ—¥æœŸæ ¼å¼åŒ–å¤±è´¥:', dateString, error);
                return dateString;
            }
        }

        // æ ¼å¼åŒ–æ•°å­—ï¼Œæ·»åŠ åƒä½åˆ†éš”ç¬¦
        function formatNumber(num) {
            if (num == null || num === '') return '0';
            const number = parseInt(num);
            if (isNaN(number)) return '0';
            return number.toLocaleString('zh-CN');
        }

        // åˆ†ç±»é¢œè‰²æ˜ å°„ï¼ˆå‚è€ƒ SinglePost.astroï¼‰
        const categoryColors = {
            "æŠ€æœ¯": { 
                bg: "bg-blue-100 dark:bg-blue-900/40", 
                text: "text-blue-700 dark:text-blue-300",
                icon: "ğŸ’»"
            },
            "å·¥å…·": { 
                bg: "bg-emerald-100 dark:bg-emerald-900/40", 
                text: "text-emerald-700 dark:text-emerald-300",
                icon: "ğŸ› ï¸"
            },
            "è®¾è®¡": { 
                bg: "bg-purple-100 dark:bg-purple-900/40", 
                text: "text-purple-700 dark:text-purple-300",
                icon: "ğŸ¨"
            },
            "èµ„æº": { 
                bg: "bg-amber-100 dark:bg-amber-900/40", 
                text: "text-amber-700 dark:text-amber-300",
                icon: "ğŸ“š"
            },
            "è§‚ç‚¹": { 
                bg: "bg-rose-100 dark:bg-rose-900/40", 
                text: "text-rose-700 dark:text-rose-300",
                icon: "ğŸ’­"
            },
            "æ–°é—»": { 
                bg: "bg-sky-100 dark:bg-sky-900/40", 
                text: "text-sky-700 dark:text-sky-300",
                icon: "ğŸ“°"
            },
            "å­¦ä¹ ": { 
                bg: "bg-indigo-100 dark:bg-indigo-900/40", 
                text: "text-indigo-700 dark:text-indigo-300",
                icon: "ğŸ“"
            }
        };

        // é»˜è®¤åˆ†ç±»æ ·å¼
        const defaultCategoryStyle = { 
            bg: "bg-gray-100 dark:bg-gray-800/60", 
            text: "text-gray-700 dark:text-gray-300",
            icon: "ğŸ·ï¸"
        };

        // è·å–åˆ†ç±»æ ·å¼
        function getCategoryStyle(category) {
            return categoryColors[category] || defaultCategoryStyle;
        }

        // æ”¹è¿›çš„Markdownæ¸²æŸ“å‡½æ•°
        function renderMarkdown(markdown) {
            if (!markdown) return '';
            
            let html = markdown;
            
            // å…ˆå¤„ç†ä»£ç å—ï¼ˆé¿å…å¹²æ‰°å…¶ä»–è§„åˆ™ï¼‰
            html = html.replace(/```(\w+)?\n([\s\S]*?)\n```/g, (match, lang, code) => {
                return `<pre><code>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`;
            });
            
            // å¤„ç†è¡Œå†…ä»£ç 
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // å¤„ç†å›¾ç‰‡ï¼ˆéœ€è¦åœ¨é“¾æ¥ä¹‹å‰å¤„ç†ï¼‰
            html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" />');
            
            // å¤„ç†é“¾æ¥
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
            
            // å¤„ç†æ ‡é¢˜
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // å¤„ç†ç²—ä½“å’Œæ–œä½“
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // å¤„ç†å¼•ç”¨
            html = html.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');
            
            // å¤„ç†åˆ—è¡¨é¡¹
            const lines = html.split('\n');
            let inList = false;
            let listItems = [];
            let processedLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                const listMatch = line.match(/^[-*+] (.+)$/);
                
                if (listMatch) {
                    if (!inList) {
                        inList = true;
                        listItems = [];
                    }
                    listItems.push(`<li>${listMatch[1]}</li>`);
                } else {
                    if (inList) {
                        processedLines.push(`<ul>${listItems.join('')}</ul>`);
                        listItems = [];
                        inList = false;
                    }
                    if (line) {
                        processedLines.push(line);
                    }
                }
            }
            
            // å¤„ç†æœ€åçš„åˆ—è¡¨
            if (inList && listItems.length > 0) {
                processedLines.push(`<ul>${listItems.join('')}</ul>`);
            }
            
            html = processedLines.join('\n');
            
            // å¤„ç†æ®µè½ï¼ˆé¿å…åœ¨HTMLæ ‡ç­¾ä¸­æ·»åŠ æ®µè½ï¼‰
            const paragraphs = html.split('\n\n').filter(p => p.trim());
            html = paragraphs.map(p => {
                const trimmed = p.trim();
                // è·³è¿‡å·²ç»æ˜¯HTMLæ ‡ç­¾çš„è¡Œ
                if (trimmed.startsWith('<') || trimmed === '') {
                    return trimmed;
                }
                return `<p>${trimmed.replace(/\n/g, '<br>')}</p>`;
            }).join('\n');
            
            return html;
        }

        // æ¸²æŸ“æœŸå·åˆ—è¡¨
        function renderIssuesList(issues) {
            const tbody = document.getElementById('issues-table-body');
            tbody.innerHTML = '';

            if (!issues || issues.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center">
                            <div class="text-gray-500 dark:text-gray-400">
                                ğŸ“„ æš‚æ— æœŸå·æ•°æ®
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            issues.forEach((issue) => {
                const statusConfig = {
                    draft: {label: 'è‰ç¨¿', color: 'yellow'},
                    published: {label: 'å·²å‘å¸ƒ', color: 'green'},
                    archived: {label: 'å·²å½’æ¡£', color: 'blue'}
                };

                const config = statusConfig[issue.status] || {label: issue.status, color: 'gray'};

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                        ç¬¬ ${issue.issue_number} æœŸ
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                        ${issue.title}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        ${formatDateOnly(issue.start_date)} ~ ${formatDateOnly(issue.end_date)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        ${issue.total_items} æ¡ / ${formatNumber(issue.total_word_count)} å­—
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-${config.color}-100 text-${config.color}-800 dark:bg-${config.color}-800 dark:text-${config.color}-100">
                            ${config.label}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex space-x-2">
                            <button data-action="preview-weekly" data-issue-id="${issue.id}" class="text-purple-600 hover:text-purple-900 dark:text-purple-400 dark:hover:text-purple-300" title="é¢„è§ˆ">
                                ğŸ‘ï¸
                            </button>
                            ${
                                issue.status === 'draft'
                                    ? `
                                <button onclick="associateContent(${issue.id})" class="text-blue-600 hover:text-blue-900 dark:text-blue-400" title="å…³è”å†…å®¹">
                                    ğŸ”—
                                </button>
                                <button onclick="publishIssue(${issue.id})" class="text-green-600 hover:text-green-900 dark:text-green-400" title="å‘å¸ƒ">
                                    ğŸ“¤
                                </button>
                            `
                                    : ''
                            }
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        function updateIssuesPagination(pagination) {
            const info = document.getElementById('issues-pagination-info');
            const prevBtn = document.getElementById('issues-prev-page');
            const nextBtn = document.getElementById('issues-next-page');

            const start = pagination.offset + 1;
            const end = Math.min(pagination.offset + pagination.limit, pagination.total);

            info.textContent = `æ˜¾ç¤º ${start}-${end} é¡¹ï¼Œå…± ${pagination.total} é¡¹`;

            prevBtn.disabled = pagination.offset === 0;
            nextBtn.disabled = !pagination.has_more;
        }

        // åŠ è½½å¾…ç»„ç»‡å†…å®¹æ•°é‡
        async function loadUnassociatedCount() {
            const countDiv = document.getElementById('unassociated-count');

            try {
                const adminKey = getCookie('admin_key') || window.expectedAdminKey;
                const response = await fetch(
                    '/api/admin/weekly/unassociated-content?admin_key=' + encodeURIComponent(adminKey) + '&limit=1'
                );
                const result = await response.json();

                if (result.success) {
                    countDiv.textContent = `å¾…ç»„ç»‡å†…å®¹: ${result.data.pagination.total} æ¡`;
                } else {
                    countDiv.textContent = 'æ— æ³•è·å–æ•°æ®';
                    countDiv.className = 'text-sm text-red-500 dark:text-red-400 text-center pt-2';
                }
            } catch (error) {
                console.error('åŠ è½½å¾…ç»„ç»‡å†…å®¹æ•°é‡å¤±è´¥:', error);
                countDiv.textContent = 'åŠ è½½å¤±è´¥';
                countDiv.className = 'text-sm text-red-500 dark:text-red-400 text-center pt-2';
            }
        }

        // åˆ›å»ºæ–°æœŸå·
        async function createNewIssue() {
            const title = document.getElementById('new-issue-title').value.trim();
            const startDate = document.getElementById('new-issue-start').value;
            const endDate = document.getElementById('new-issue-end').value;

            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }

            try {
                showLoading();

                const adminKey = getCookie('admin_key') || window.expectedAdminKey;
                const response = await fetch('/api/admin/weekly/create-issue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-key': adminKey
                    },
                    body: JSON.stringify({
                        title: title || undefined,
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`æœŸå·åˆ›å»ºæˆåŠŸï¼æœŸå·: ${result.data.issue_number}`);

                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('new-issue-title').value = '';
                    document.getElementById('new-issue-start').value = '';
                    document.getElementById('new-issue-end').value = '';

                    // åˆ·æ–°æ•°æ®
                    await loadWeeklyDashboard();
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ›å»ºæœŸå·å¤±è´¥:', error);
                alert('åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                hideLoading();
            }
        }

        // å…¨å±€å‡½æ•°å®šä¹‰ - ä¾›HTML onclickäº‹ä»¶ä½¿ç”¨
        window.associateContent = async function (issueId) {
            // è¿™é‡Œåº”è¯¥æ‰“å¼€ä¸€ä¸ªæ¨¡æ€æ¡†æ¥é€‰æ‹©å†…å®¹
            alert('å…³è”å†…å®¹åŠŸèƒ½å¾…å®ç° - æœŸå·ID: ' + issueId);
        };

        window.publishIssue = async function (issueId) {
            if (!confirm('ç¡®å®šè¦å‘å¸ƒè¿™æœŸå‘¨åˆŠå—ï¼Ÿå‘å¸ƒåå°†æ— æ³•ä¿®æ”¹ã€‚')) {
                return;
            }

            try {
                showLoading();

                const adminKey = getCookie('admin_key') || window.expectedAdminKey;
                const response = await fetch('/api/admin/weekly/publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-key': adminKey
                    },
                    body: JSON.stringify({weekly_issue_id: issueId})
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message || 'å‘å¸ƒæˆåŠŸï¼');
                    await loadWeeklyDashboard();
                } else {
                    alert('å‘å¸ƒå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('å‘å¸ƒæœŸå·å¤±è´¥:', error);
                alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                hideLoading();
            }
        };



        document.addEventListener('DOMContentLoaded', function () {
            // åˆå§‹åŒ–æ ‡ç­¾åŠŸèƒ½
            initTabs();

            // åˆå§‹åŒ–å‘¨åˆŠç®¡ç†äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('create-issue-btn').addEventListener('click', createNewIssue);
            document.getElementById('refresh-issues').addEventListener('click', () => {
                // é‡ç½®åŠ è½½çŠ¶æ€ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½
                const weeklyTab = document.getElementById('weekly-tab');
                weeklyTab.dataset.loaded = 'false';
                loadWeeklyDashboard();
            });
            document.getElementById('status-filter').addEventListener('change', () => {
                currentIssuesPage = 0;
                loadIssuesList();
            });

            // åˆ†é¡µæŒ‰é’®äº‹ä»¶
            document.getElementById('issues-prev-page').addEventListener('click', () => {
                if (currentIssuesPage > 0) {
                    currentIssuesPage--;
                    loadIssuesList();
                }
            });

            document.getElementById('issues-next-page').addEventListener('click', () => {
                currentIssuesPage++;
                loadIssuesList();
            });

            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            const endOfWeek = new Date(today);
            endOfWeek.setDate(today.getDate() + (6 - today.getDay()));

            document.getElementById('new-issue-start').value = startOfWeek.toISOString().split('T')[0];
            document.getElementById('new-issue-end').value = endOfWeek.toISOString().split('T')[0];

            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ‰€æœ‰æŒ‰é’®ç‚¹å‡»
            document.addEventListener('click', handleButtonClick);

            // é«˜çº§è®¾ç½®æŠ˜å æŒ‰é’®
            const toggleAdvancedBtn = document.getElementById('toggle-advanced');
            if (toggleAdvancedBtn) {
                toggleAdvancedBtn.addEventListener('click', toggleAdvancedSettings);
            }

            // å…¨é€‰/åé€‰ï¼ˆè¡¨å¤´å¤é€‰æ¡†ï¼‰
            const headerCheckbox = document.getElementById('select-all-header');
            if (headerCheckbox) {
                headerCheckbox.addEventListener('change', function () {
                    const checkboxes = document.querySelectorAll('.content-checkbox');
                    checkboxes.forEach((cb) => (cb.checked = this.checked));
                    updateBatchToolbar();
                });
            }

            // å…¨é€‰æŒ‰é’®
            const selectAllBtn = document.getElementById('select-all');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function () {
                    const checkboxes = document.querySelectorAll('.content-checkbox');
                    checkboxes.forEach((cb) => (cb.checked = true));
                    if (headerCheckbox) headerCheckbox.checked = true;
                    updateBatchToolbar();
                });
            }

            // æ¸…é™¤é€‰æ‹©æŒ‰é’®
            const clearSelectionBtn = document.getElementById('clear-selection');
            if (clearSelectionBtn) {
                clearSelectionBtn.addEventListener('click', function () {
                    const checkboxes = document.querySelectorAll('.content-checkbox');
                    checkboxes.forEach((cb) => (cb.checked = false));
                    if (headerCheckbox) headerCheckbox.checked = false;
                    updateBatchToolbar();
                });
            }

            // ä¸ºæ‰€æœ‰å†…å®¹å¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.content-checkbox').forEach((checkbox) => {
                checkbox.addEventListener('change', updateBatchToolbar);
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            const previewModal = document.getElementById('preview-modal');
            if (previewModal) {
                previewModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        closePreview();
                    }
                });
            }

            // ESCé”®å…³é—­é¢„è§ˆ
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closePreview();
                }
            });
        });
    </script>
</Layout>
