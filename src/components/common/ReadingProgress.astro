---
/**
 * 阅读进度条组件
 * 固定在页面顶部，显示文章阅读进度
 */
---

<div
  id="reading-progress"
  class="fixed top-0 left-0 right-0 z-50 h-1 bg-primary/20 dark:bg-primary/10"
  role="progressbar"
  aria-label="阅读进度"
  aria-valuenow="0"
  aria-valuemin="0"
  aria-valuemax="100"
  data-reading-progress
>
  <div
    class="h-full bg-gradient-to-r from-primary via-accent-warm to-primary bg-size-200 animate-gradient transition-all duration-300 ease-out"
    style="width: 0%"
    data-progress-bar
  ></div>
</div>

<script>
  class ReadingProgressBar {
    private progressBar: HTMLElement | null = null;
    private container: HTMLElement | null = null;
    private ticking = false;

    constructor() {
      this.progressBar = document.querySelector('[data-progress-bar]');
      this.container = document.querySelector('[data-reading-progress]');
      
      if (this.progressBar && this.container) {
        this.init();
      }
    }

    private init() {
      window.addEventListener('scroll', () => this.handleScroll(), { passive: true });
      this.updateProgress();
    }

    private handleScroll() {
      if (!this.ticking) {
        requestAnimationFrame(() => {
          this.updateProgress();
          this.ticking = false;
        });
        this.ticking = true;
      }
    }

    private updateProgress() {
      if (!this.progressBar || !this.container) return;

      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      
      // 计算进度百分比
      const scrollableHeight = documentHeight - windowHeight;
      const progress = (scrollTop / scrollableHeight) * 100;
      const clampedProgress = Math.max(0, Math.min(100, progress));

      // 更新进度条宽度
      this.progressBar.style.width = `${clampedProgress}%`;
      this.container.setAttribute('aria-valuenow', clampedProgress.toFixed(0));

      // 当进度为 0 时隐藏进度条
      if (clampedProgress === 0) {
        this.container.style.opacity = '0';
      } else {
        this.container.style.opacity = '1';
      }
    }
  }

  // 初始化阅读进度条
  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      new ReadingProgressBar();
    });

    document.addEventListener('astro:page-load', () => {
      new ReadingProgressBar();
    });
  }
</script>

<style>
  #reading-progress {
    transition: opacity 0.3s ease;
  }

  /* 渐变动画 */
  @keyframes gradient {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }

  .animate-gradient {
    background-size: 200% 200%;
    animation: gradient 3s ease infinite;
  }

  /* 减少动画 */
  @media (prefers-reduced-motion: reduce) {
    .animate-gradient {
      animation: none;
    }

    [data-progress-bar] {
      transition: none !important;
    }
  }
</style>
