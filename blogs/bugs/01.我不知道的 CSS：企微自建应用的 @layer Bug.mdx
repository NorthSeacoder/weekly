---
tags: [bug, css, å…¼å®¹æ€§, layer, å‰ç«¯å¼€å‘]
category: Bugs
date: 2024-07-16
title: æˆ‘ä¸çŸ¥é“çš„ CSSï¼šä¼å¾®è‡ªå»ºåº”ç”¨çš„ @layer Bug ğŸš€
slug: bug-css-wecom
desc: æ·±å…¥åˆ†æä¼å¾®è‡ªå»ºåº”ç”¨ä¸­ç”± @layer å¼•èµ·çš„ CSS å…¼å®¹æ€§é—®é¢˜ï¼Œæä¾›è¯¦ç»†çš„æ’æŸ¥æµç¨‹ä¸è§£å†³æ–¹æ¡ˆï¼ŒåŠ©ä½ å¿«é€Ÿè§£å†³é—®é¢˜ã€‚
---

### èƒŒæ™¯

åœ¨ä¼å¾®è‡ªå»ºåº”ç”¨çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬é€‰ç”¨äº† `@umijs/max` + `tailwindcss` + `antd` çš„æŠ€æœ¯æ ˆã€‚è¿™å¥—ç»„åˆåœ¨å¿«é€Ÿå¼€å‘å’Œç»„ä»¶æ”¯æŒä¸Šè¡¨ç°ä¼˜å¼‚ï¼Œä½† Tailwind CSS å’Œ Ant Design çš„æ ·å¼å†²çªæˆäº†éš¾é¢˜ã€‚ä¸ºä¼˜é›…è§£å†³å†²çªï¼Œæˆ‘ä»¬å¼•å…¥äº† CSS `@layer` æŒ‡ä»¤ï¼Œé€šè¿‡åˆ†å±‚ç®¡ç†æ ·å¼ä¼˜å…ˆçº§ã€‚é…ç½®å¦‚ä¸‹ï¼š

```css
// tailwind.css
@layer tailwind-base, antd;

@layer tailwind-base {
    @tailwind base;
}

@tailwind components;
@tailwind utilities;
```

`@layer tailwind-base, antd;` å®šä¹‰äº† `tailwind-base`ï¼ˆTailwind åŸºç¡€æ ·å¼ï¼‰å’Œ `antd`ï¼ˆAnt Design æ ·å¼ï¼‰ä¸¤å±‚ï¼Œæ—¨åœ¨éš”ç¦»å†²çªï¼Œä½¿æ ·å¼ç®¡ç†æ›´æ¸…æ™°ã€‚

### Bug è¡¨ç° ğŸ›

ç„¶è€Œï¼Œåœ¨éƒ¨åˆ† macOS ç³»ç»Ÿçš„ä¼å¾®å†…ç½®æµè§ˆå™¨ä¸­ï¼Œé¡µé¢å‡ºç°äº†ä¸¥é‡é—®é¢˜ï¼š

-   **æ ·å¼å¤§é¢ç§¯ç¼ºå¤±ï¼š** å…ƒç´ å¤±å»æ ·å¼ï¼Œå¸ƒå±€é”™ä¹±ï¼Œç»„ä»¶å¤±æ•ˆï¼Œé¡µé¢åƒâ€œè£¸å¥”â€ä¸€æ ·ã€‚
-   **éå¿…ç°ä½†ç¨³å®šå¤ç°ï¼š** å¹¶éæ‰€æœ‰ç”¨æˆ·é‡åˆ°ï¼Œä½†åœ¨ç‰¹å®š macOS ç”¨æˆ·ä¸­ç¨³å®šé‡ç°ï¼Œæ’æŸ¥éš¾åº¦å€å¢ã€‚

### Debug æµç¨‹ï¼šä»ç°è±¡åˆ°æ ¹å›  ğŸ¤”

é¢å¯¹è¿™ä¸ªâ€œè–›å®šè°”çš„ bugâ€ï¼Œæˆ‘ä»¬æŒ‰ä»¥ä¸‹æ­¥éª¤æŠ½ä¸å‰¥èŒ§ï¼š

1. **ç°è±¡è§‚å¯Ÿä¸å¤ç°**  
   ç”¨æˆ·åé¦ˆæ˜¾ç¤ºï¼Œbug é›†ä¸­åœ¨ macOS ç³»ç»Ÿçš„ä¼å¾®å†…ç½®æµè§ˆå™¨ï¼ŒWindows å’Œ Chrome ä¸‹æ­£å¸¸ã€‚åˆæ­¥æµ‹è¯•å‘ç°ï¼Œæ ·å¼ä¸¢å¤±ä¸ä¼å¾®ç‰ˆæœ¬æ— å…³ï¼ŒæŒ‡å‘ç³»ç»Ÿæˆ–æµè§ˆå™¨å·®å¼‚ã€‚

2. **é€æ­¥æ’æŸ¥**

    - **ç‰ˆæœ¬æµ‹è¯•ï¼š** å¯¹æ¯”å¤šç‰ˆæœ¬ä¼å¾®å®¢æˆ·ç«¯ï¼Œbug ä¸ä¼å¾®ç‰ˆæœ¬æ— ç›´æ¥å…³è”ï¼Œæ’é™¤å®¢æˆ·ç«¯å› ç´ ã€‚
    - **ç¯å¢ƒé”å®šï¼š** æ”¶é›† UA æ•°æ®ï¼Œå‘ç° macOS ä¸‹ä¼å¾®å†…ç½®æµè§ˆå™¨åŸºäº Safari å†…æ ¸ï¼Œä¸”ç‰ˆæœ¬ä¸ç³»ç»Ÿ Safari ä¸€è‡´ï¼ˆä¾‹å¦‚ `AppleWebKit/605.1.15`ï¼‰ã€‚
    - **å…¼å®¹æ€§éªŒè¯ï¼š** æŸ¥çœ‹ [Can I Use](https://caniuse.com/css-layer)ï¼Œç¡®è®¤ `@layer` åœ¨ Safari 15.4 betaï¼ˆmacOS 12.4ï¼‰å‰æ”¯æŒä¸å®Œå–„ï¼Œè€ç‰ˆæœ¬ï¼ˆå¦‚ 15.3ï¼‰å¯èƒ½å¿½ç•¥ `@layer` è§„åˆ™ã€‚

3. **æ ¹å› åˆ†æ**  
   çœŸç›¸æµ®å‡ºæ°´é¢ï¼šä¼å¾®åœ¨ macOS ä¸‹é»˜è®¤ä½¿ç”¨ Safari å†…æ ¸æ¸²æŸ“å†…ç½®æµè§ˆå™¨ï¼Œéƒ¨åˆ†ç”¨æˆ· macOS æœªæ›´æ–°ï¼ŒSafari ç‰ˆæœ¬ä½äº 15.4ï¼Œå¯¼è‡´ `@layer` è§£æå¤±è´¥ï¼Œæ ·å¼æœªåº”ç”¨ã€‚è¿™æ˜¯ bug çš„æ ¸å¿ƒåŸå› ã€‚

4. **è§£å†³æ–¹æ¡ˆä¸éªŒè¯**  
   ä¸ºå…¼å®¹è€ç‰ˆæœ¬ Safariï¼Œæˆ‘ä»¬å¼•å…¥ `postcss-preset-env` æ’ä»¶ï¼Œåœ¨ Umi ä¸­é…ç½®å¦‚ä¸‹ï¼š

    ```js
    // config/config.ts
    import {defineConfig} from '@umijs/max';
    const postcssPresetEnv = require('postcss-preset-env');

    export default defineConfig({
        extraPostCSSPlugins: [postcssPresetEnv()]
    });
    ```

    è¯¥æ’ä»¶å°† `@layer` è½¬æ¢ä¸ºè€æµè§ˆå™¨å¯è¯†åˆ«çš„ CSS è¯­æ³•ã€‚é‡æ–°æ„å»ºåï¼Œåœ¨é—®é¢˜ç¯å¢ƒæµ‹è¯•ï¼Œæ ·å¼æ¢å¤æ­£å¸¸ï¼Œbug è§£å†³ ğŸ‰ã€‚

### æŠ€æœ¯ä¹‹å¤–çš„æ€è€ƒ ğŸ’¡

#### ç”¨æˆ·ä½“éªŒ

-   **ç°çŠ¶ï¼š** ä¾èµ–ç”¨æˆ·åé¦ˆå‘ç° bugï¼Œå“åº”æ»åã€‚
-   **æ”¹è¿›ï¼š** ä½¿ç”¨ Sentry ç›‘æ§ CSS å¼‚å¸¸ï¼Œå…·ä½“å®è·µå¦‚ä¸‹ï¼š

    ```js
    import * as Sentry from '@sentry/browser';

    Sentry.init({dsn: 'your-dsn'});

    // ç›‘æ§ CSS æ–‡ä»¶åŠ è½½å¤±è´¥
    document.querySelectorAll('link[rel="stylesheet"]').forEach((link) => {
        link.onerror = () => {
            Sentry.captureMessage(`CSS åŠ è½½å¤±è´¥: ${link.href}`, 'error');
        };
    });

    // æ£€æµ‹å…³é”®å…ƒç´ æ ·å¼æ˜¯å¦ç¬¦åˆé¢„æœŸ
    window.addEventListener('load', () => {
        const el = document.querySelector('.key-element');
        if (!el) {
            Sentry.captureMessage('å…³é”®å…ƒç´ æœªæ‰¾åˆ°', 'error');
            return;
        }

        const style = window.getComputedStyle(el);
        const expectedWidth = '128px'; // å‡è®¾ w-32 = 8rem = 128px
        const isWidthMissing = style.width !== expectedWidth && (style.width === '0px' || !style.width);
        const isDisplayHidden = style.display === 'none' || style.visibility === 'hidden';

        if (isWidthMissing && !isDisplayHidden) {
            Sentry.captureMessage(
                `å…³é”®å…ƒç´ æ ·å¼å¼‚å¸¸ï¼Œé¢„æœŸå®½åº¦ ${expectedWidth}ï¼Œå®é™… ${style.width}`,
                'warning'
            );
        }
    });
    ```

-   **æ•ˆæœï¼š** ä¸»åŠ¨æ•è· `@layer` å¤±æ•ˆå¯¼è‡´çš„æ ·å¼å¼‚å¸¸ï¼Œå¯å¤ç”¨äºå…¶ä»– CSS å…¼å®¹æ€§é—®é¢˜ã€‚

#### é¡¹ç›®ç®¡ç†ï¼šåŠ å¼ºè·¨æµè§ˆå™¨æµ‹è¯•

-   **ç°çŠ¶ï¼š** æµ‹è¯•ä¸è¶³ï¼Œä¸Šçº¿åæš´éœ²é—®é¢˜ã€‚
-   **æ”¹è¿›ï¼š** æ­å»ºè‡ªå»ºäº‘æµ‹å¹³å°ï¼ˆåŸºäº [f2etest](https://github.com/alibaba/f2etest)ï¼‰ï¼Œè¦†ç›– macOSï¼ˆSafari 15.3+ï¼‰ã€Windowsï¼ˆEdgeã€Chromeï¼‰ã€‚CI/CD é›†æˆï¼š
    ```yaml
    # .github/workflows/test.yml
    steps:
        - name: Run f2etest Cloud Tests
          run: node f2etest.js --browsers "safari@15.3,chrome@120"
    ```
-   **æ•ˆæœï¼š** æˆæœ¬ä½ã€å¯å®šåˆ¶ï¼Œä¸Šçº¿å‰éªŒè¯å…¼å®¹æ€§ã€‚

#### å›¢é˜Ÿåä½œï¼šæ•´ç† CR å…³æ³¨ç‚¹

-   **ç°çŠ¶ï¼š** ç¼ºä¹å…¼å®¹æ€§æ£€æŸ¥ï¼ŒCR æµäºå½¢å¼ã€‚
-   **æ”¹è¿›ï¼š** æ•´ç† CR å…³æ³¨ç‚¹æ–‡æ¡£ï¼š
    -   æ–° CSS ç‰¹æ€§éœ€è¯´æ˜å…¼å®¹æ€§ï¼ˆå¦‚ `@layer` Safari < 15.4 ä¸æ”¯æŒï¼‰ã€‚
    -   å·¥å…·é…ç½®éœ€æ³¨é‡Šç”¨é€”ï¼ˆå¦‚ PostCSS è§£å†³å…¼å®¹æ€§ï¼‰ã€‚
    -   é€šè¿‡ GitHub PR åˆ†æï¼Œç›‘æ§è¯„è®ºç‡ï¼ˆç›®æ ‡ï¼šæ¯ PR è‡³å°‘ 2 æ¡æœ‰æ•ˆè¯„è®ºï¼‰ã€‚
    -   ç¤ºä¾‹ï¼š
        ```css
        /* @layer éš”ç¦»æ ·å¼ï¼ŒSafari < 15.4 ä¸æ”¯æŒï¼Œä¾èµ– postcss-preset-env */
        @layer tailwind-base, antd;
        ```
-   **æ•ˆæœï¼š** æé«˜ CR è´¨é‡ï¼Œç¡®ä¿åä½œæœ‰æ•ˆã€‚

### å®ç”¨å»ºè®® ğŸ’ª

1. **æŸ¥è¯¢å…¼å®¹æ€§è„šæœ¬**  
   å¿«é€Ÿæ£€æŸ¥ç‰¹æ€§æ”¯æŒï¼š

    ```bash
    npx caniuse @layer --browsers "safari >= 15, chrome >= 99"
    ```

2. **é…ç½® Browserslist**  
   åœ¨ `package.json` æŒ‡å®šç›®æ ‡æµè§ˆå™¨ï¼š

    ```json
    "browserslist": [
        "> 0.5%",
        "last 2 versions",
        "Safari >= 15"
    ]
    ```

    **æ³¨æ„ï¼š** è‹¥è¿è¡Œåœ¨ä½äºæŒ‡å®šç‰ˆæœ¬çš„æµè§ˆå™¨ï¼ˆå¦‚ Safari 14ï¼‰ï¼ŒPostCSS ä¸ä¼šç”Ÿæˆå…¼å®¹ä»£ç ï¼Œ`@layer` å¯èƒ½å¤±æ•ˆï¼Œæ ·å¼ç¼ºå¤±ã€‚

3. **è°ƒè¯•æŠ€å·§ï¼šç‰¹å¾æ£€æµ‹ä¸äº‘æµ‹**
    - **ç‰¹å¾æ£€æµ‹ï¼š** æ£€æŸ¥ `@layer` æ”¯æŒï¼š
        ```js
        if (!CSS.supports('@layer')) {
            console.warn('æµè§ˆå™¨ä¸æ”¯æŒ @layer');
        }
        ```
    - **äº‘æµ‹éªŒè¯ï¼š** ä½¿ç”¨ f2etest åœ¨çœŸå®è®¾å¤‡ä¸Šæµ‹è¯•ï¼Œé¿å… UA ä¼ªè£…å±€é™æ€§ã€‚

### æ€»ç»“

ä» `@layer` bug çš„æ’æŸ¥åˆ°è§£å†³ï¼Œæˆ‘ä»¬ä¸ä»…ä¿®å¤äº†æŠ€æœ¯é—®é¢˜ï¼Œè¿˜ä¼˜åŒ–äº†ç”¨æˆ·ä½“éªŒã€é¡¹ç›®æµç¨‹å’Œå›¢é˜Ÿåä½œã€‚å¸Œæœ›è¿™äº›ç»éªŒå’Œå·¥å…·åŠ©ä½ åœ¨å‰ç«¯å¼€å‘ä¸­å°‘è¸©å‘ï¼Œé¡¹ç›®æ›´ç¨³å®š ğŸš€ã€‚
