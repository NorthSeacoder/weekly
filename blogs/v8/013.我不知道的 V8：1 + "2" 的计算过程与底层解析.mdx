---
tags: [å‰ç«¯å¼€å‘, V8, JavaScript, ç±»å‹è½¬æ¢, æ€§èƒ½ä¼˜åŒ–]
category: V8
date: 2024-03-07
title: æˆ‘ä¸çŸ¥é“çš„ V8ï¼š1 + "2" çš„è®¡ç®—è¿‡ç¨‹ä¸åº•å±‚è§£æ
desc: æ­ç§˜ V8 å¦‚ä½•å¤„ç† 1 + "2"ï¼Œä»ç±»å‹è½¬æ¢åˆ°åŠ æ³•è¿ç®—çš„åº•å±‚é€»è¾‘ã€‚
slug: v8-js-engine-13
---

åœ¨ JavaScript ä¸­ï¼Œ`1 + "2"` çš„ç»“æœæ˜¯ "12"ï¼Œè¿™èƒŒåæ¶‰åŠç±»å‹è½¬æ¢å’ŒåŠ æ³•è¿ç®—çš„å¤æ‚é€»è¾‘ã€‚V8 å¼•æ“å¦‚ä½•å¤„ç†è¿™ä¸€æ“ä½œï¼Ÿå¸ƒå°”å€¼ `true` å¦‚ä½•å˜æˆæ•°å­— `1`ï¼Ÿä¹˜æ³•ä¸ºä½•ä¸åŒï¼Ÿä»Šå¤©ï¼Œæˆ‘ä»¬å°†ä» `1 + "2"` çš„è¡Œä¸ºå…¥æ‰‹ï¼Œæ‰©å±•åˆ°å„ç§ç±»å‹çš„åŠ æ³•é€»è¾‘ï¼Œæ·±å…¥ V8 çš„å­—èŠ‚ç ä¸å®ç°ï¼Œæœ€ç»ˆæ­ç¤º ECMAScript çš„è§„èŒƒå®šä¹‰ã€‚ğŸš€

---

## 1. åŠ æ³•çš„ç»“æœï¼šä¸ºä»€ä¹ˆæ˜¯ "12"ï¼Ÿ

åœ¨ JavaScript ä¸­ï¼Œ`+` è¿ç®—ç¬¦æ—¢èƒ½è¿›è¡Œæ•°å€¼åŠ æ³•ï¼Œä¹Ÿèƒ½æ‰§è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå…·ä½“å–å†³äºæ“ä½œæ•°çš„ç±»å‹ï¼š

```javascript
console.log(1 + 2); // 3ï¼Œæ•°å€¼åŠ æ³•
console.log(1 + '2'); // "12"ï¼Œå­—ç¬¦ä¸²æ‹¼æ¥
console.log('1' + '2'); // "12"ï¼Œå­—ç¬¦ä¸²æ‹¼æ¥
```

å¯¹äº `1 + "2"`ï¼š

-   ä¸€ä¸ªæ“ä½œæ•°æ˜¯æ•°å­—ï¼ˆ`1`ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å­—ç¬¦ä¸²ï¼ˆ`"2"`ï¼‰ã€‚
-   JavaScript å°†æ•°å­—è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼ˆ`ToString(1)` â†’ "1"ï¼‰ï¼Œç„¶åæ‹¼æ¥ä¸º "12"ã€‚

### å…¶ä»–ç±»å‹çš„åŠ æ³•

-   **å¸ƒå°”å€¼**ï¼š
    ```javascript
    console.log(true + '2'); // "true2"
    console.log(1 + true); // 2
    ```
    -   å½“ä¸å­—ç¬¦ä¸²æ‹¼æ¥æ—¶ï¼Œ`true` è½¬ä¸º "true"ï¼›å½“ä¸æ•°å­—ç›¸åŠ æ—¶ï¼Œä¾æ®è§„èŒƒè½¬ä¸º `1`ï¼Œä½“ç°å¸ƒå°”å€¼åœ¨æ•°å€¼ä¸Šä¸‹æ–‡ä¸‹çš„æ˜ç¡®æ˜ å°„ã€‚
-   **å¯¹è±¡**ï¼š
    ```javascript
    console.log({} + '2'); // "[object Object]2"
    console.log({valueOf: () => 3} + '2'); // "32"
    ```
    -   å¯¹è±¡å…ˆè°ƒç”¨ `valueOf`ï¼Œè‹¥ä¸å¯ç”¨åˆ™è°ƒç”¨ `toString`ã€‚
-   **æ•°ç»„**ï¼š
    ```javascript
    console.log([1, 2] + '2'); // "1,22"
    console.log(1 + [1, 2]); // "11,2"
    ```
    -   å¯¹äº `1 + [1, 2]`ï¼Œæ•°ç»„ `[1, 2]` è°ƒç”¨ `toString()` è½¬ä¸º "1,2"ï¼ˆå…ƒç´ ç”¨é€—å·è¿æ¥ï¼‰ï¼Œ`1` è½¬ä¸º "1"ï¼Œæ‹¼æ¥ä¸º "11,2"ã€‚

è¿™äº›è¡Œä¸ºæºäºç±»å‹è½¬æ¢è§„åˆ™ï¼Œä½† V8 å¦‚ä½•å®ç°ï¼Ÿ

---

## 2. V8 çš„æ‰§è¡Œæµç¨‹ï¼šç±»å‹å¤„ç†ä¸åŠ æ³•æ“ä½œ

V8 å°† JavaScript ç¼–è¯‘ä¸ºå­—èŠ‚ç å¹¶è¿è¡Œï¼Œ`+` çš„å¤„ç†æ¶‰åŠç±»å‹æ£€æµ‹å’ŒåŠ¨æ€åˆ†æ´¾ã€‚

### ç±»å‹æ£€æµ‹ä¸è½¬æ¢

V8 åœ¨è¿è¡Œæ—¶æ£€æŸ¥æ“ä½œæ•°çš„ç±»å‹ï¼š

-   `1` æ˜¯ `Number`ï¼ˆSmiï¼ŒSmall Integerï¼‰ã€‚
-   `"2"` æ˜¯ `String`ï¼ˆHeapObjectï¼‰ã€‚

#### å…¶ä»–ç±»å‹

-   **å¸ƒå°”**ï¼š
    -   å½“ä¸æ•°å­—ç›¸åŠ ï¼ˆå¦‚ `1 + true`ï¼‰ï¼Œ`true` é€šè¿‡ `ToNumber` è½¬ä¸º `1`ï¼Œ`false` è½¬ä¸º `0`ï¼Œè¿™æ˜¯ ECMAScript ä¸ºå¸ƒå°”å€¼åœ¨æ•°å€¼è¿ç®—ä¸­å®šä¹‰çš„è§„åˆ™ã€‚
    -   å½“ä¸å­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆå¦‚ `true + "2"`ï¼‰ï¼Œ`ToString(true)` è¿”å› "true"ã€‚
-   **å¯¹è±¡/æ•°ç»„**ï¼šè½¬ä¸ºåŸå§‹å€¼åå¤„ç†ã€‚
-   **null/undefined**ï¼š
    ```javascript
    console.log(1 + null); // 1ï¼Œnull è½¬ä¸º 0
    console.log(1 + undefined); // NaNï¼Œundefined è½¬ä¸º NaN
    ```

#### å¯¹è±¡åŠ æ³•çš„ç‰¹æ®Šå¤„ç†

å¯¹è±¡ä½¿ç”¨ `+` æ—¶ï¼ŒV8 éµå¾ª `ToPrimitive` è§„åˆ™ï¼š

1. è°ƒç”¨ `valueOf()`ï¼Œè‹¥è¿”å›åŸå§‹å€¼ï¼Œåˆ™ä½¿ç”¨ã€‚
2. è‹¥ä¸å¯ç”¨ï¼Œè°ƒç”¨ `toString()`ã€‚

```javascript
const obj = {
    valueOf: () => 3,
    toString: () => 'obj'
};
console.log(obj + '2'); // "32"
```

### åŠ æ³•æ“ä½œçš„åˆ†æ´¾

V8 æ ¹æ®ç±»å‹å†³å®šï¼š

-   **ä¸¤æ•°ç›¸åŠ **ï¼šæ•°å€¼è¿ç®—ã€‚
-   **å«å­—ç¬¦ä¸²**ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ã€‚
-   **å…¶ä»–ç»„åˆ**ï¼šè½¬æ¢åå¤„ç†ã€‚

#### `1 + "2"` çš„æµç¨‹

1. æ£€æŸ¥ç±»å‹ï¼šå‘ç°å­—ç¬¦ä¸²ã€‚
2. `ToString(1)` â†’ "1"ã€‚
3. "1" + "2" â†’ "12"ã€‚

#### å…¶ä»–ç¤ºä¾‹

-   `1 + true`ï¼š
    1. `ToNumber(true)` â†’ `1`.
    2. `1 + 1` â†’ `2`.
-   `1 + [1, 2]`ï¼š
    1. `ToString([1, 2])` â†’ "1,2"ã€‚
    2. `ToString(1)` â†’ "1"ã€‚
    3. "1" + "1,2" â†’ "11,2"ã€‚

### å¯¹æ¯”å…¶ä»–è¿ç®—

ä¹˜æ³•ï¼ˆ`*`ï¼‰ã€å‡æ³•ï¼ˆ`-`ï¼‰ç­‰è¿ç®—ç¬¦ä¸åŠ æ³•ä¸åŒï¼Œå®ƒä»¬ä¼˜å…ˆæ•°å€¼è®¡ç®—ï¼š

```javascript
console.log(1 * '2'); // 2
console.log(1 - true); // 0
```

-   ä¹˜æ³•å°†å­—ç¬¦ä¸² "2" é€šè¿‡ `ToNumber` è½¬ä¸º `2`ï¼Œ`true` è½¬ä¸º `1`ï¼Œå› ä¸ºè¿™äº›è¿ç®—ç¬¦æ˜¯ä¸ºæ•°å€¼è®¾è®¡ï¼Œä¸æ”¯æŒå­—ç¬¦ä¸²æ‹¼æ¥ã€‚
-   åŠ æ³•å› å†å²è®¾è®¡å…¼é¡¾æ‹¼æ¥ï¼Œæˆä¸ºç‰¹ä¾‹ã€‚

---

## 3. å­—èŠ‚ç ä¸åº•å±‚å®ç°ï¼šV8 çš„é­”æ³•

### å­—èŠ‚ç ç”Ÿæˆ

V8 çš„ Ignition è§£é‡Šå™¨å°†ä»£ç è½¬ä¸ºå­—èŠ‚ç ï¼š

```javascript
function add() {
    return 1 + '2';
}
console.log(add());
```

å­—èŠ‚ç ï¼ˆä¼ªä»£ç ï¼Œå¸¦æ³¨é‡Šï¼‰ï¼š

```
LdaSmi [1]          ; åŠ è½½å°æ•´æ•° 1
ToString            ; å°† 1 è½¬ä¸º "1"ï¼ˆæ˜¾å¼è½¬æ¢æ•°å­—ä¸ºå­—ç¬¦ä¸²ï¼‰
LdaConstant ["2"]   ; åŠ è½½å¸¸é‡ "2"ï¼ˆé¢„å­˜çš„å­—ç¬¦ä¸²ï¼Œé¿å…è¿è¡Œæ—¶æ„é€ ï¼‰
Add                 ; å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œç»“æœ "12"
Return
```

#### å…¶ä»–ç±»å‹

-   `1 + true`ï¼š
    ```
    LdaSmi [1]
    LdaTrue
    ToNumber           ; true è½¬ä¸º 1
    Add                ; æ•°å€¼åŠ æ³•ï¼Œç»“æœ 2
    ```
-   `{ valueOf: () => 3 } + "2"`ï¼š
    ```
    LdaObject          ; åŠ è½½å¯¹è±¡
    CallProperty0 [valueOf]  ; è°ƒç”¨ valueOf()ï¼Œè¿”å› 3
    ToString           ; è½¬ä¸º "3"
    LdaConstant ["2"]
    Add                ; æ‹¼æ¥ä¸º "32"
    ```

### ç±»å‹è½¬æ¢å®ç°

-   **`ToPrimitive`**ï¼ˆå¯¹è±¡ï¼‰ï¼š
    ```cpp
    Object* ToPrimitive(Isolate* isolate, Handle<Object> obj) {
      Handle<Object> result = Object::ValueOf(obj);
      if (result->IsPrimitive()) return *result;
      return Object::ToString(obj);
    }
    ```
-   **`ToString`**ï¼š
    -   æ•°å­—è½¬ä¸ºåè¿›åˆ¶å­—ç¬¦ä¸²ã€‚
    -   å¸ƒå°”åœ¨åŠ æ³•ä¸­ï¼Œè‹¥å¦ä¸€æ“ä½œæ•°ä¸ºå­—ç¬¦ä¸²ï¼Œ`ToString(true)` è¿”å› "true"ï¼›è‹¥ä¸ºæ•°å­—ï¼Œå…ˆ `ToNumber(true)` è½¬ä¸º `1`ï¼Œå†æ ¹æ®åŠ æ³•è§„åˆ™å†³å®šæ˜¯å¦è½¬ä¸ºå­—ç¬¦ä¸²ã€‚
-   **`ToNumber`**ï¼šå¸ƒå°”è½¬ä¸º `1/0`ï¼Œå­—ç¬¦ä¸²è§£æä¸ºæ•°å­—ã€‚

### å­—ç¬¦ä¸²æ‹¼æ¥

-   V8 åˆ†é…æ–° `HeapString`ï¼š
    ```
    HeapString "12":
      - length: 2
      - data: ['1', '2']
    ```

### æ€§èƒ½ä¼˜åŒ–

-   **å†…è”ç¼“å­˜ï¼ˆICï¼‰**ï¼šç¼“å­˜ `valueOf/toString` è°ƒç”¨ã€‚
-   **TurboFan**ï¼šçƒ­ç‚¹ä»£ç å†…è”ç»“æœã€‚
-   **å­—ç¬¦ä¸²æ± **ï¼šå°å­—ç¬¦ä¸²å¤ç”¨ã€‚

---

## 4. éªŒè¯ä¸æ€è€ƒ

### è°ƒè¯•éªŒè¯

ç”¨ `--print-bytecode` æŸ¥çœ‹ï¼š

```bash
node --print-bytecode script.js
```

è§‚å¯Ÿ `ToString` å’Œ `Add` çš„è°ƒç”¨ã€‚

### ç±»å‹å½±å“

```javascript
console.time('add');
for (let i = 0; i < 1e6; i++) 1 + [1, 2];
console.timeEnd('add');
```

---

## 5. ECMAScript çš„å®šä¹‰ï¼šåŠ æ³•è¿ç®—çš„æ ¹æº

ECMAScript è§„èŒƒï¼ˆES2023ï¼ŒSection 11.6.1ï¼‰å®šä¹‰äº† `+` çš„è¡Œä¸ºï¼š

1. **æ“ä½œæ•°è½¬æ¢**ï¼š
    - `lprim = ToPrimitive(left)`ï¼Œ`rprim = ToPrimitive(right)`ã€‚
    - å¦‚æœä»»ä¸€ä¸ºå­—ç¬¦ä¸²ï¼Œ`ToString(lprim) + ToString(rprim)`ã€‚
    - å¦åˆ™ï¼Œ`ToNumber(lprim) + ToNumber(rprim)`ã€‚
2. **ToPrimitive**ï¼ˆå¯¹è±¡ï¼‰ï¼š
    - è°ƒç”¨ `valueOf()`ï¼Œè‹¥è¿”å›åŸå§‹å€¼åˆ™ç”¨ã€‚
    - å¦åˆ™è°ƒç”¨ `toString()`ã€‚
3. **æ‰§è¡Œ**ï¼š
    - `1 + "2"`ï¼š`ToString(1)` â†’ "1"ï¼Œ`"1" + "2"` â†’ "12".
    - `1 + true`ï¼š`ToNumber(true)` â†’ `1`ï¼Œ`1 + 1` â†’ `2`ã€‚

---

## 6. æ€»ç»“ï¼šä» "12" åˆ° V8 çš„æ™ºæ…§

V8 å¤„ç† `1 + "2"` åŠå…¶ä»–åŠ æ³•å±•ç¤ºäº†å…¶çµæ´»æ€§ï¼š

-   **è§„åˆ™**ï¼šå­—ç¬¦ä¸²ä¼˜å…ˆæ‹¼æ¥ï¼Œå¯¹è±¡å…ˆ `valueOf` å `toString`ï¼Œå¸ƒå°”ä¾ä¸Šä¸‹æ–‡è½¬æ¢ã€‚
-   **å®ç°**ï¼šå­—èŠ‚ç åˆ†æ­¥å¤„ç†ã€‚
-   **è§„èŒƒ**ï¼šECMAScript å®šä¹‰äº†ä¸€åˆ‡ã€‚

ç†è§£è¿™äº›ï¼Œä½ èƒ½æ›´ç²¾å‡†åœ°æŒæ§ä»£ç è¡Œä¸ºï¼Œä¼˜åŒ–æ€§èƒ½ä¸å¯è¯»æ€§ï¼ğŸ’¡
