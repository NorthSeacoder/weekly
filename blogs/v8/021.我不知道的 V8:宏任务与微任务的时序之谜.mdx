---
tags: [å‰ç«¯å¼€å‘, V8, JavaScript, å®ä»»åŠ¡, å¾®ä»»åŠ¡]
category: V8
date: 2024-03-13
title: æˆ‘ä¸çŸ¥é“çš„ V8:å®ä»»åŠ¡ä¸Žå¾®ä»»åŠ¡çš„æ—¶åºä¹‹è°œ
desc: æ·±å…¥ V8 ä¸­å®ä»»åŠ¡ä¸Žå¾®ä»»åŠ¡çš„æ—¶åºï¼Œå‰–æžä»»åŠ¡è°ƒåº¦ä¸Žæ‰§è¡Œçš„åº•å±‚é€»è¾‘ã€‚
slug: v8-js-engine-21
---

V8 å¼•æ“Žçš„äº‹ä»¶å¾ªçŽ¯å†³å®šäº† JavaScript å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼Œå®ä»»åŠ¡å’Œå¾®ä»»åŠ¡çš„æ—¶åºæ˜¯å…¶ä¸­å…³é”®ã€‚ä»Ž setTimeout çš„å»¶è¿Ÿåˆ° Promise çš„å³æ—¶å›žè°ƒï¼Œå®ƒä»¬çš„è¿è¡Œæœºåˆ¶å¦‚ä½•å®žçŽ°ï¼Ÿä»Šå¤©ï¼Œæˆ‘ä»¬å°†ä»Žå®ä»»åŠ¡ä¸Žå¾®ä»»åŠ¡çš„æ—¶åºå…¥æ‰‹ï¼Œæ·±å…¥å‰–æž V8 çš„ä»»åŠ¡è°ƒåº¦é€»è¾‘ï¼Œåˆ†æžå¾®ä»»åŠ¡é˜Ÿåˆ—çš„åº•å±‚å®žçŽ°ä¸Ž MutationObserver çš„å¾®ä»»åŠ¡é›†æˆï¼Œæ­ç¤ºå®ƒä»¬å¦‚ä½•åä½œä¼˜åŒ–å¼‚æ­¥æ‰§è¡Œã€‚è¿™æ˜¯ä¸€åœºä»Žä»»åŠ¡è§¦å‘åˆ°æ—¶åºæŽŒæŽ§çš„å®Œæ•´æ—…ç¨‹ï¼Œå¸¦ä½ èµ°è¿› V8 çš„æ ¸å¿ƒæœºåˆ¶ã€‚ðŸš€

---

## 1. å®ä»»åŠ¡ä¸Žå¾®ä»»åŠ¡çš„æ—¶åºæ„ä¹‰

åœ¨ V8 ä¸­ï¼Œå®ä»»åŠ¡ï¼ˆMacrotasksï¼Œå¦‚ setTimeoutã€I/Oï¼‰å’Œå¾®ä»»åŠ¡ï¼ˆMicrotasksï¼Œå¦‚ Promiseã€MutationObserverï¼‰å…±åŒé©±åŠ¨å¼‚æ­¥æ‰§è¡Œã€‚å®ä»»åŠ¡è´Ÿè´£å»¶è¿Ÿæ“ä½œï¼Œå¾®ä»»åŠ¡å¤„ç†å³æ—¶å›žè°ƒï¼Œå®ƒä»¬çš„æ—¶åºå†³å®šäº†ä»£ç çš„è¿è¡ŒèŠ‚å¥ã€‚

**ä¸ºä½•é‡è¦**:V8 é€šè¿‡äº‹ä»¶å¾ªçŽ¯åè°ƒä¸¤è€…ï¼Œç¡®ä¿å¼‚æ­¥ä»»åŠ¡æœ‰åºæ‰§è¡Œã€‚å¾®ä»»åŠ¡çš„é«˜ä¼˜å…ˆçº§å’Œå®ä»»åŠ¡çš„é˜Ÿåˆ—è°ƒåº¦å½¢æˆäº†ç‹¬ç‰¹çš„æ—¶åºé€»è¾‘ï¼Œç›´æŽ¥å½±å“æ€§èƒ½ä¸Žå“åº”æ€§ã€‚ç†è§£è¿™ä¸€ç‚¹æ˜¯ä¼˜åŒ–å¼‚æ­¥ä»£ç çš„ç¬¬ä¸€æ­¥ã€‚

---

## 2. å®ä»»åŠ¡çš„è°ƒåº¦:é˜Ÿåˆ—ç®¡ç†çš„åº•å±‚é€»è¾‘

å®ä»»åŠ¡çš„æ—¶åºä»Žé˜Ÿåˆ—è°ƒåº¦å¼€å§‹ã€‚ä»¥ setTimeout ä¸ºä¾‹:

```javascript
setTimeout(() => console.log('Macro'), 0);
```

**è°ƒåº¦æµç¨‹**:V8 å°†å›žè°ƒäº¤ç»™ Web API çš„å®šæ—¶å™¨æ¨¡å—ï¼Œå»¶æ—¶ç»“æŸåŽæŽ¨å…¥å®ä»»åŠ¡é˜Ÿåˆ—ã€‚é˜Ÿåˆ—ç”±æµè§ˆå™¨çš„äº‹ä»¶å¾ªçŽ¯ç®¡ç†ï¼ŒV8 çš„ `TaskRunner` ä»Žä¸­æå–ä»»åŠ¡ï¼Œç”Ÿæˆç‹¬ç«‹çš„è°ƒç”¨æ ˆæ‰§è¡Œã€‚æ¯ä¸ªå®ä»»åŠ¡å®ŒæˆåŽï¼Œè§¦å‘æ–°ä¸€è½®å¾ªçŽ¯ã€‚

**åº•å±‚ç»†èŠ‚**:V8 çš„ `Libevent` æˆ– `MessagePump`ï¼ˆè§†å¹³å°è€Œå®šï¼‰ç»´æŠ¤å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œé‡‡ç”¨ FIFO ç»“æž„ã€‚ä»»åŠ¡è°ƒåº¦å—æµè§ˆå™¨æ¸²æŸ“å’Œè¾“å…¥äº‹ä»¶çš„ä¼˜å…ˆçº§å½±å“ï¼Œå»¶æ—¶ 0ms ä¹Ÿä¸ä¿è¯ç«‹å³æ‰§è¡Œï¼Œéœ€ç­‰å¾…å½“å‰ä»»åŠ¡æ ˆæ¸…ç©ºã€‚

---

## 3. å¾®ä»»åŠ¡çš„æ’å…¥:é˜Ÿåˆ—çš„åŠ¨æ€æž„å»º

å¾®ä»»åŠ¡çš„æ—¶åºä¾èµ–å…¶é˜Ÿåˆ—çš„åŠ¨æ€æž„å»ºã€‚V8 åœ¨è¿è¡Œæ—¶ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„å¾®ä»»åŠ¡é˜Ÿåˆ—:

```javascript
Promise.resolve().then(() => console.log('Micro'));
```

**æž„å»ºæœºåˆ¶**:è°ƒç”¨ `then` æ—¶ï¼ŒV8 åˆ›å»º `PromiseReaction` å¯¹è±¡ï¼Œå°†å›žè°ƒæŽ¨å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚é˜Ÿåˆ—å­˜å‚¨åœ¨ `MicrotaskQueue` ç»“æž„ä¸­ï¼Œä¸Žå½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡ç»‘å®šã€‚V8 åœ¨æ¯ä¸ªå®ä»»åŠ¡åŽæ£€æŸ¥é˜Ÿåˆ—ï¼Œè‹¥ä¸ä¸ºç©ºåˆ™æ¸…ç©ºæ‰§è¡Œã€‚

**æ‰§è¡Œæ—¶æœº**:å¾®ä»»åŠ¡çš„è§¦å‘ç‚¹æ˜¯è°ƒç”¨æ ˆæ¸…ç©ºï¼ˆCall Stack Emptyï¼‰ï¼Œé€šå¸¸åœ¨å®ä»»åŠ¡æˆ–è„šæœ¬æ‰§è¡ŒåŽã€‚è¿™ä¸Žå®ä»»åŠ¡çš„é˜Ÿåˆ—è°ƒåº¦å½¢æˆå¯¹æ¯”ï¼Œå¾®ä»»åŠ¡æ’é˜Ÿæ‰§è¡Œï¼Œç¡®ä¿å³æ—¶æ€§ã€‚

---

## 4. MutationObserver çš„è§‚å¯Ÿ:å¾®ä»»åŠ¡çš„ DOM å»¶ä¼¸

MutationObserver æ˜¯ V8 ä¸­åŸºäºŽå¾®ä»»åŠ¡çš„ DOM ç›‘å¬å·¥å…·:

```javascript
const observer = new MutationObserver(() => console.log('DOM Changed'));
observer.observe(document.body, {childList: true});
document.body.appendChild(document.createElement('div'));
```

**åº•å±‚å®žçŽ°**:V8 çš„ DOM ä¿®æ”¹ï¼ˆå¦‚ `appendChild`ï¼‰è§¦å‘ `MutationRecord`ï¼Œè®°å½•å˜åŒ–ç»†èŠ‚ã€‚è¿™äº›è®°å½•è¢«æŽ¨å…¥ MutationObserver çš„é˜Ÿåˆ—ï¼Œç»‘å®šåˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚V8 åœ¨æ ˆæ¸…ç©ºæ—¶è°ƒç”¨ `InvokeMicrotaskQueue`ï¼Œä¾æ¬¡æ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡ï¼ŒåŒ…æ‹¬ MutationObserver å›žè°ƒã€‚

**æ—¶åºç‰¹æ€§**:MutationObserver çš„å¾®ä»»åŠ¡æ‰§è¡Œä¸Ž Promise åŒçº§ï¼Œç¡®ä¿ DOM å˜åŒ–åŽç«‹å³å“åº”ï¼Œä¼˜äºŽå®ä»»åŠ¡çš„å»¶è¿Ÿè°ƒåº¦ã€‚

---

## 5. æ—¶åºé—­çŽ¯:å®ä»»åŠ¡ä¸Žå¾®ä»»åŠ¡çš„åä½œ

å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡åœ¨ V8 çš„äº‹ä»¶å¾ªçŽ¯ä¸­åä½œï¼Œå½¢æˆæ—¶åºé—­çŽ¯:

-   **å®ä»»åŠ¡**:é€šè¿‡ `TaskRunner` è°ƒåº¦ï¼Œé©±åŠ¨ä¸»æµç¨‹ã€‚
-   **å¾®ä»»åŠ¡**:é€šè¿‡ `MicrotaskQueue` æ’é˜Ÿï¼Œå¤„ç†å³æ—¶å›žè°ƒã€‚
-   **MutationObserver**:ä½œä¸ºå¾®ä»»åŠ¡å»¶ä¼¸ï¼Œå“åº” DOM å˜åŒ–ã€‚

**åä½œé€»è¾‘**:V8 åœ¨æ¯ä¸ªå®ä»»åŠ¡åŽè°ƒç”¨ `PerformMicrotaskCheckpoint`ï¼Œæ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª setTimeout ä¿®æ”¹ DOMï¼ŒMutationObserver å’Œ Promise å›žè°ƒåœ¨å¾®ä»»åŠ¡ä¸­é¡ºåºæ‰§è¡Œï¼ŒéšåŽè¿›å…¥ä¸‹ä¸€å®ä»»åŠ¡ã€‚è¿™ç§é—­çŽ¯è®¾è®¡ä¼˜åŒ–äº†å¼‚æ­¥æ‰§è¡Œçš„æ—¶åºä¸Žæ€§èƒ½ã€‚

---

## 6. å¯ç¤ºä¸Žæ€»ç»“:æ—¶åºä¼˜åŒ–çš„æ™ºæ…§ä¸Žå®žè·µ

V8 çš„å®ä»»åŠ¡ä¸Žå¾®ä»»åŠ¡æ—¶åºä¸ä»…æ˜¯è°ƒåº¦æœºåˆ¶ï¼Œæ›´ä¸ºå¼€å‘è€…æä¾›äº†ä¼˜åŒ–ç©ºé—´ã€‚ä»¥ä¸‹æ˜¯ä»Žå‰æ–‡æç‚¼çš„å®žç”¨å¯ç¤º:

-   **é¿å…å¾®ä»»åŠ¡è¿‡è½½**:å¾®ä»»åŠ¡åœ¨å®ä»»åŠ¡åŽæ¸…ç©ºï¼Œè¿‡å¤šä»»åŠ¡ä¼šå»¶è¿Ÿä¸‹ä¸€å®ä»»åŠ¡:

    ```javascript
    setTimeout(() => {
        for (let i = 0; i < 1000; i++) {
            Promise.resolve().then(() => console.log(i));
        }
    }, 0);
    ```

    **ä¼˜åŒ–å»ºè®®**:åˆ†æ‰¹å¤„ç†å¾®ä»»åŠ¡ï¼ˆå¦‚ç”¨ setTimeout åˆ†å‰²ï¼‰ï¼Œé¿å…é˜»å¡žäº‹ä»¶å¾ªçŽ¯ã€‚

-   **åˆ©ç”¨å¾®ä»»åŠ¡æ£€æŸ¥ç‚¹**:å¾®ä»»åŠ¡é€‚åˆå³æ—¶é€»è¾‘ï¼Œå¦‚çŠ¶æ€åŒæ­¥:

    ```javascript
    Promise.resolve().then(() => updateUI());
    ```

    **ä¼˜åŒ–å»ºè®®**:å°† DOM æ›´æ–°åŽçš„æ£€æŸ¥é€»è¾‘æ”¾å…¥å¾®ä»»åŠ¡ï¼Œç¡®ä¿åœ¨æ¸²æŸ“å‰å®Œæˆï¼Œæå‡å“åº”æ€§ã€‚

-   **MutationObserver çš„æ‰¹é‡å¤„ç†**:é¢‘ç¹ DOM ä¿®æ”¹è§¦å‘å¤šæ¬¡å›žè°ƒï¼Œå¢žåŠ å¾®ä»»åŠ¡è´Ÿè½½:
    ```javascript
    const observer = new MutationObserver(() => console.log('Changed'));
    observer.observe(document.body, {childList: true});
    for (let i = 0; i < 10; i++) {
        document.body.appendChild(document.createElement('div'));
    }
    ```
    **ä¼˜åŒ–å»ºè®®**:ç”¨ `DocumentFragment` æ‰¹é‡æ“ä½œ DOMï¼Œåˆå¹¶å˜åŒ–ä¸ºå•æ¬¡å›žè°ƒï¼Œå‡å°‘å¾®ä»»åŠ¡æ‰§è¡Œæ¬¡æ•°ã€‚

**æ€»ç»“æ™ºæ…§**:V8 çš„æ—¶åºæœºåˆ¶é€šè¿‡å®ä»»åŠ¡çš„èŠ‚å¥ä¸Žå¾®ä»»åŠ¡çš„å³æ—¶æ€§åä½œï¼Œç¡®ä¿å¼‚æ­¥æ‰§è¡Œçš„é«˜æ•ˆä¸Žæœ‰åºã€‚ç†è§£å…¶åº•å±‚é€»è¾‘ï¼Œèƒ½è®©ä½ æ›´ç²¾å‡†åœ°ä¼˜åŒ–ä»»åŠ¡è°ƒåº¦ã€‚

---

## æ€»ç»“:ä»Žæ··æ²Œåˆ°æœ‰åºçš„æ—…ç¨‹

V8 çš„å®ä»»åŠ¡ä¸Žå¾®ä»»åŠ¡æ—¶åºå°†å¼‚æ­¥ä»£ç å˜ä¸ºæœ‰åºæ‰§è¡Œã€‚å®ä»»åŠ¡è°ƒåº¦å¥ åŸºï¼Œå¾®ä»»åŠ¡åŠ¨æ€æ’é˜Ÿï¼ŒMutationObserver ç²¾å‡†è§‚å¯Ÿï¼Œæœ€ç»ˆå½¢æˆæ—¶åºé—­çŽ¯ã€‚è¿™æ˜¯ä¸€ä¸ªä»Žä»»åŠ¡è§¦å‘åˆ°æ‰§è¡Œä¼˜åŒ–çš„å®Œæ•´é“¾æ¡ï¼Œæ¯ä¸€æ­¥éƒ½ä¸å¯æˆ–ç¼ºã€‚ç†è§£è¿™ä¸€è¿‡ç¨‹ï¼Œä½ ä¼šæ›´ä»Žå®¹åœ°æŽŒæŽ§å¼‚æ­¥é€»è¾‘ã€‚ä¸‹æ¬¡ä½¿ç”¨ Promise æ—¶ï¼Œæƒ³æƒ³è¿™èƒŒåŽçš„å¹•åŽé€»è¾‘å§ï¼ðŸ’¡

---

**æƒ³äº†è§£æ›´å¤š V8 çš„ç§˜å¯†ï¼Ÿ** ç•™è¨€å‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šç»§ç»­æ‹†è§£ï¼
